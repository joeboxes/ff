<html>
<head>
<title>Stock Market</title>
<script src="../code/FF.js"></script>
</head>
<script type="text/javascript">
function pageLoadedFxn(){
	var ff = new FF("../code/",ffLoadedFxn);
}
function ffLoadedFxn(){
	(new ScriptLoader("./",[],this,classesLoadedFxn)).load();
}

function setupDisplay(){
	this._canvas = new Canvas(null,0,0,Canvas.STAGE_FIT_FILL, false,false, true);
	this._stage = new Stage(this._canvas, 1000/20);
	this._root = new DO();
	this._stage.addChild(this._root);
	GLOBALSTAGE = this._stage;
	this._canvas.addListeners();
	this._stage.addListeners();
	this._stage.start();
}
function classesLoadedFxn(){
	setupDisplay();







	var apiKey = "onDdyiZFL8sEA7ssiclKLKdvsJxjXbqI";
	console.log("classesLoadedFxn");
// list of watching tickers
	var positions = {
	"AAL":{"b":20.00, "s":26.00},
	"AAPL":{"b":130.00, "s":145.00},
	"ABNB":{"b":135.00, "s":200.00},
	"AI":{"b":50.00, "s":110.0},
	"AIQ":{"b":28.00, "s":31.00},
	"AIR":{"b":36.00, "s":45.00},
	"ALK":{"b":56.00, "s":74.00},
	"AMD":{"b":80.00, "s":98.00},
	"AMWD":{"b":76.00, "s":105.00},
	"APXT":{"b":0.00, "s":14.50},
	"ARMK":{"b":34.00, "s":41.00},
	"AYRO":{"b":0.00, "s":6.75},
	//
	"BA":{"b":220.00, "s":270.00},
	"BFIT":{"b":29.00, "s":33.00},
	"BLL":{"b":79.00, "s":95.00},
	"BLMN":{"b":24.00, "s":30.0},
	"BLOK":{"b":44.50, "s":52.00},
	"CAKE":{"b":45.00, "s":64.00},
	"CAT":{"b":209.00, "s":240.00},
	"CBRL":{"b":140.00, "s":170.00},
	"CCL":{"b":23.00, "s":32.00},
	"CHEF":{"b":28.50, "s":36.00},
	"CHPT":{"b":22.00, "s":41.00},
	"CHWY":{"b":67.00, "s":105.00},
	"CLF":{"b":20.50, "s":25.00},
	"CLDT":{"b":11.50, "s":15.00},
	"CLIX":{"b":75.00, "s":97.00},
	"COST":{"b":350.00, "s":410.00},
	"CR":{"b":86.00, "s":98.00},
	"CUK":{"b":21.00, "s":27.00},
	"CWK":{"b":17.00, "s":20.00},
	//
	"DAL":{"b":41.00, "s":52.00},
	"DASH":{"b":140.00, "s":200.00},
	"DENN":{"b":14.00, "s":19.00},
	"DIN":{"b":82.00, "s":100.00},
	"DIS":{"b":165.00, "s":200.00},
	"DM":{"b":0.00, "s":32.00},
	"DRI":{"b":130.00, "s":150.00},
	"EKAR":{"b":38.00, "s":42.00},
	"EPR":{"b":49.00, "s":56.00},
	"ERTH":{"b":60.00, "s":81.00},
	"ESPO":{"b":66.00, "s":75.00},
	"ESS":{"b":300.00, "s":320.0},
	"ETH":{"b":25.00, "s":31.00},
	"ETSY":{"b":160.00, "s":220.00},
	"EVAX":{"b":5.00, "s":8.50},
	"F":{"b":13.00, "s":16.00},
	"FDX":{"b":280.00, "s":315.00},
	"FLY":{"b":0.00, "s":999.99},
	"FRT":{"b":113.00, "s":125.00},
	"FUN":{"b":44.50, "s":52.00},
	//
	"GAMR":{"b":91.00, "s":100.00},
	"GD":{"b":184.00, "s":195.00},
	"GE":{"b":12.50, "s":14.50},
	"H":{"b":76.00, "s":90.00},
	"HA":{"b":21.00, "s":30.00},
	"HAS":{"b":91.00, "s":100.00},
	"HFFG":{"b":0.00, "s":6.00},
	"HOFT":{"b":33.00, "s":41.00},
	"HXL":{"b":55.00, "s":64.00},
	"IBUY":{"b":115.00, "s":135.00},
	"INTU":{"b":410.00, "s":510.00},
	"JBLU":{"b":15.50, "s":21.00},
	"JETS":{"b":23.00, "s":28.00},
	"JNJ":{"b":156.00, "s":169.00},
	"JPM":{"b":147.00, "s":166.00},
	"JWN":{"b":32.00, "s":45.00},
	"KBAL":{"b":12.25, "s":15.00},
	"KSS":{"b":50.00, "s":66.00},
	//
	"LAZR":{"b":0.00, "s":32.00},
	"LB":{"b":62.00, "s":73.00},
	"LIT":{"b":65.00, "s":78.00},
	"LOGI":{"b":116.00, "s":140.00},
	"LOUP":{"b":50.00, "s":60.00},
	"LRNZ":{"b":40.00, "s":47.00},
	"LSCC":{"b":47.00, "s":57.00},
	"LTC":{"b":37.50, "s":44.00},
	"LUV":{"b":50.00, "s":62.00},
	"LZB":{"b":35.00, "s":42.00},
	"M":{"b":17.00, "s":21.00},
	"MAIN":{"b":40.00, "s":45.00},
	"MDB":{"b":320.00, "s":390.00},
	"MLHR":{"b":44.00, "s":50.00},
	"MRNA":{"b":195, "s":250.00},
	"MU":{"b":76.00, "s":95.00},
	"NCLH":{"b":26.00, "s":34.00},
	"NERD":{"b":29.00, "s":35.00},
	"NKE":{"b":145.00, "s":165.00},
	"NNDM":{"b":0.00, "s":14.00},
	"NNN":{"b":45.00, "s":51.00},
	"NTGR":{"b":36.00, "s":43.00},
	"O":{"b":66.00, "s":72.00},
	"OKTA":{"b":217.00, "s":285.00},
	"ONLN":{"b":74.00, "s":86.00},
	"ORCL":{"b":80.00, "s":94.00},
	//
	"PBS":{"b":52.00, "s":57.00},
	"PFE":{"b":35.00, "s":41.00},
	"PFGC":{"b":45.00, "s":58.00},
	"PK":{"b":18.00, "s":24.00},
	"PLAY":{"b":35.00, "s":48.00},
	"PLTR":{"b":20.00, "s":27.00},
	"PLYA":{"b":6.50, "s":8.20},
	"PSFE":{"b":0.00, "s":15.00},
	"QSR":{"b":63.00, "s":71.00},
	"RBLX":{"b":81.00, "s":99.00},
	"RCII":{"b":51.00, "s":64.00},
	"RCL":{"b":77.00, "s":96.00},
	"RGI":{"b":181.00, "s":191.00},
	"RMCF":{"b":6.00, "s":8.50},
	"RMR":{"b":37.50, "s":43.00},
	"ROKU":{"b":380.00, "s":450.00},
	"RRGB":{"b":30.00, "s":40.00},
	"RTX":{"b":82.00, "s":90.00},
	"RUTH":{"b":20.00, "s":26.50},
	//
	"SAVE":{"b":27.00, "s":38.00},
	"SBUX":{"b":109.00, "s":119.00},
	"SCS":{"b":13.50, "s":16.00},
	"SE":{"b":225.00, "s":290.00},
	"SIX":{"b":40.00, "s":50.00},
	"SKYW":{"b":40.00, "s":55.00},
	"SMH":{"b":230.00, "s":262.00},
	"SNAP":{"b":55.00, "s":70.00},
	"SOCL":{"b":65.00, "s":75.00},
	"SOXX":{"b":400.00, "s":455.00},
	"SPHD":{"b":42.00, "s":46.00},
	"SPXX":{"b":17.50, "s":19.00},
	"SQ":{"b":210.00, "s":275},
	"STOR":{"b":34.00, "s":36.25},
	"SYY":{"b":74.00, "s":85.00},
	"TEAM":{"b":225.00, "s":267.00},
	"TGT":{"b":220.00, "s":250.00},
	"THNQ":{"b":39.00, "s":45.00},
	"TMUS":{"b":134.00, "s":174.00},
	"TSLA":{"b":600.00, "s":720.00},
	"TXN":{"b":176.00, "s":195.00},
	//
	"U":{"b":93.00, "s":145.00},
	"UAA":{"b":19.50, "s":25.00},
	"UAL":{"b":48.50, "s":62.00},
	"UPST":{"b":116.00, "s":170.0},
	"USFD":{"b":34.50, "s":41.50},
	"VBK":{"b":270.00, "s":299.00},
	"VCR":{"b":292.00, "s":315.00},
	"VER":{"b":42.00, "s":49.00},
	"VGT":{"b":360.00, "s":410.00},
	"VIOG":{"b":215.00, "s":231.00},
	"VIRC":{"b":3.10, "s":3.80},
	"VIS":{"b":190.00, "s":201.00},
	"VO":{"b":225.00, "s":239.00},
	"VOO":{"b":390.00, "s":400.00},
	"VOOG":{"b":255.00, "s":269.00},
	"VOT":{"b":220.00, "s":238.00},
	"VTHR":{"b":194.00, "s":201.00},
	"VTR":{"b":54.00, "s":59.00},
	"VTWG":{"b":208.00, "s":240.00},
	"VUG":{"b":275.00, "s":295.00},
	"VV":{"b":195.00, "s":202.00},
	"VXF":{"b":175.00, "s":190.00},
	//
	"WELL":{"b":78.00, "s":90.00},
	"WH":{"b":65.00, "s":77.00},
	"WPC":{"b":74.50, "s":79.00},
	"WYNN":{"b":17.00, "s":139.00},
	"XBUY":{"b":50.00, "s":60.00},
	"XHR":{"b":17.25, "s":21.00},
	"XITK":{"b":195.00, "s":240.00},
	"XLNX":{"b":115.00, "s":150.00},
	"XRT":{"b":91.00, "s":99.00},
	"XWEB":{"b":160.00, "s":195.00},
	"YUM":{"b":114.00, "s":122.00},
	"ZEN":{"b":132.00, "s":155.00},
	"ZG":{"b":109.00, "s":175.00},
	};
	// MISSING:
	// ,"CCX" ,"SIRC"
	// PSFE, ERTH
	// CHPT,RBLX
	// ...


var tickers = Code.keys(positions);

// console.log(tickers);
// console.log(positions);
// throw "..."

var timeBetweenAPICalls = 12000; // 5 requests per minute: (60/5) = 12 second intervals
var totalRequestCountTotal = 10;

// return;

	tickers = Code.filterArray(tickers, function(v){
		return v != "" ? true : false;
	});
	tickers.sort(function(a,b){
		return a<b ? -1 : 1;
	});
	console.log("TICKER COUNT: "+tickers.length);


// setup service
	var service = new Polygon(apiKey);





	
	console.log(tickers);

	// local storage info
	var storageDataKey = "databaseStocks";
	var storage = window.localStorage;
	// console.log(storage);

	// window.localStorage.getItem("databaseStocks");
	// Code.parseJSON(window.localStorage.getItem("databaseStocks"));

	var loadData = function(){
		var str = storage.getItem(storageDataKey);
		// console.log(str);
		if(!str){
			return null;
		}
		var object = Code.parseJSON(str);
		// console.log(object);
		return object;
	}
	var saveData = function(object)
	{
		var str = Code.StringFromJSON(object);
		storage.setItem(storageDataKey, str);
	}


	// var callbackFxn = function(data){
	// 	// console.log(data);
	// 	var object = Code.parseJSON(data);
	// 	console.log(object);
	// 	saveData(object);
	// }

	// clear
	// window.localStorage.clear();
	// window.localStorage.removeItem(storageDataKey);
	// return;





	// get data for each date
	var doData = function(){
		var data = loadData();
		console.log(data);
		if(!data){
			console.log("MISSING DATA");
			// service.getFullMarketData(2021,6,25,callbackFxn);
		}else{
			console.log("HAVE DATA");
			// extract only relevant ticker values
		}
	}


	var getReleventDataFxn = function(object){
		// console.log(object);
		var list = object["results"];
		if(!list){
			// throw "no results";
			console.log("no results");
			return null;
		}
		// save it anyway
		// convert to table:
		var table = {};
		for(var i=0; i<list.length; ++i){
			var entry = list[i];
			var ticker = entry["T"];
			var weightedPrice = entry["vw"];
			var openPrice = entry["o"];
			var closePrice = entry["c"];
			var avgPrice = (openPrice+closePrice)*0.5;
			var data = {};
				// data["p"] = weightedPrice;
				// data["p"] = closePrice;
				data["p"] = avgPrice;
			table[ticker] = data;
		}
		/*
		var price = list[ticker]["o"];
		/*
		T: "PFS" -- ticker
		c: 23.88 -- close
		h: 23.88 -- high
		l: 23.54 -- low
		n: 3838 -- transaction count
		o: 23.8 -- open
		t: 1624651200000 - timestamp start
		v: 1520528 - trading volume
		vw: 23.8561 - volume weighted avg price
		*/
		// get subset
		var keep = {};
		for(var i=0; i<tickers.length; ++i){
			var ticker = tickers[i];
			var data = table[ticker];
			if(!data){
				console.log("missing ticker: "+ticker);
			}else{
				keep[ticker] = data;
			}
		}
		// console.log(keep);
		// saveData(object);
		return keep;
	}


	var currentServiceDate = null;
	var currentServiceData = null;

	var continueAggregationList = function(container, count){
//		--count;
		if(count<=0){
			console.log("count to 0");
			return;
		}
		if(container.length==0){
			console.log("container to 0");
			return;
		}
		var date = container.pop();
		currentServiceDate = date;
		if(!currentServiceData){
			currentServiceData = loadData();
		}
		// console.log(currentServiceData);
		if(!currentServiceData){
			currentServiceData = {};
			currentServiceData["tickers"] = {};
		}
		var existing = currentServiceData["tickers"][currentServiceDate];

// console.log(currentServiceData);
// console.log(currentServiceDate);
// console.log(existing);
// throw "..."

		if(existing===undefined){ // null is a valid already found entry
			console.log("need to get "+currentServiceDate);

setTimeout(function() {

			var year = currentServiceDate.substr(0,4);
			var month = currentServiceDate.substr(5,2);
			var day = currentServiceDate.substr(8,2);
			year = parseInt(year);
			month = parseInt(month);
			day = parseInt(day);
			console.log(year,month,day);
			service.getFullMarketData(year,month,day,function(result, request){
				// console.log(result);
				// console.log(request);
				var responseCode = request.responseCode();
				console.log("RESPONSE: "+responseCode);
			
			if(responseCode==429){
				console.log("TOO MANY REQUESTS ...");
				throw "...";
			}

				
				var object = Code.parseJSON(result);
				var list = getReleventDataFxn(object);
				// console.log(list);
				console.log("SAVE & CONTINUE ...");
				currentServiceData["tickers"][currentServiceDate] = list;
				saveData(currentServiceData);
				// console.log(currentServiceData);
				continueAggregationList(container,count-1);
			});
},timeBetweenAPICalls);
		}else{
			// console.log("already have "+currentServiceDate);
			continueAggregationList(container,count);
		}
	}

	var dateListInRange = function(dateStart,dateEnd){
		var timeStart = Code.getDateFromTimeStamp(dateStart).getTime();
		var timeEnd = Code.getDateFromTimeStamp(dateEnd).getTime();
		
		var dateCurrent = dateStart;

		var dateList = [];
		for(var i=0; i<1000; ++i){
			// console.log(dateCurrent);
			var d = Code.getDateFromTimeStamp(dateCurrent);
			// console.log(d);
			var s = Code.getSimpleDateStringFromDate(d);
			
			if(Code.getIsWeekendFromDate(d)){
				// continue;
				// console.log(s+"   is weekend "+Code.getDayOfWeek(d));
			}else{
				// console.log(s+" - ");
				dateList.push(s);
			}
			
			d.setDate(d.getDate()+1);
			var time = d.getTime();
			if(time>timeEnd){
				console.log("end");
				break;
			}
			// dateCurrent = (d.getTime());
			dateCurrent = Code.getTimeStampFromDate(d);
		}
		// console.log(dateList);
		return dateList;
	}


	var aggregateData = function(){
		// var dateStart = Code.getTimeStamp(2021, 1, 1, 0, 0, 0, 0);
		// var dateStart = Code.getTimeStamp(2021, 3, 1, 0, 0, 0, 0);
		// var dateStart = Code.getTimeStamp(2021, 4, 1, 0, 0, 0, 0);
		var dateStart = Code.getTimeStamp(2021, 5, 1, 0, 0, 0, 0);
		// var dateEnd = Code.getTimeStamp(2021, 6, 29, 0, 0, 0, 0);
		// var dateEnd = Code.getTimeStamp(2021, 7, 1, 0, 0, 0, 0);
		// var dateEnd = Code.getTimeStamp(2021, 7, 3, 0, 0, 0, 0);
		var dateEnd = Code.getTimeStamp(2021, 7, 8, 0, 0, 0, 0);
		var dateList = dateListInRange(dateStart,dateEnd);
		continueAggregationList(dateList, totalRequestCountTotal);
	}


	var plotData = function(){
		console.log("plotData");

// AIRLINE + CRUISLINE
// tickers = [
// "AAL","ALK","CCL","CUK","DAL","HA","JBLU","JETS","LUV","NCLH","RCL","SAVE","SKYW","UAL"
// ];




// tech
// tickers = [
// "AAPL","ABNB","AI","AMD","BLOK","DASH","ETSY","ESPO","EKAR","GAMR","FDX","INTU","LIT","LOGI","LOUP","LRNZ","LSCC","MDB","NERD","NTGR","ORCL","OKTA",
// "ONLN","PBS","RBLX","ROKU","DIS","SMH","SNAP","SOCL","SQ","U","XBUY","XITK","XLNX","TXN","THNQ","XWEB","ZEN","ZG",
// ];

// etf
// tickers = ["VBK","VCR","VGT","VIOG","VIS","VO","VOO","VOOG","VOT","VTHR","VTWG","VUG","VV","VXF"];

// ...
// // tickers = ["","","","","","","","","","","","",];

		// var dateStart = Code.getTimeStamp(2021, 6, 1, 0, 0, 0, 0);
		// var dateEnd = Code.getTimeStamp(2021, 6, 28, 0, 0, 0, 0);
		// var dateStart = Code.getTimeStamp(2021, 1, 1, 0, 0, 0, 0);
		// var dateStart = Code.getTimeStamp(2021, 3, 1, 0, 0, 0, 0);
		// var dateStart = Code.getTimeStamp(2021, 4, 1, 0, 0, 0, 0);
		// var dateStart = Code.getTimeStamp(2021, 5, 1, 0, 0, 0, 0);
		// var dateStart = Code.getTimeStamp(2021, 6, 1, 0, 0, 0, 0);
		// var dateStart = Code.getTimeStamp(2021, 6, 10, 0, 0, 0, 0);
		// var dateStart = Code.getTimeStamp(2021, 6, 20, 0, 0, 0, 0);
		// var dateStart = Code.getTimeStamp(2021, 6, 23, 0, 0, 0, 0);
		// var dateStart = Code.getTimeStamp(2021, 6, 25, 0, 0, 0, 0);
		var dateStart = Code.getTimeStamp(2021, 6, 28, 0, 0, 0, 0)
		// var dateEnd = Code.getTimeStamp(2021, 6, 29, 0, 0, 0, 0);
		// var dateStart = Code.getTimeStamp(2021, 7, 1, 0, 0, 0, 0)
		var dateEnd = Code.getTimeStamp(2021, 7, 9, 0, 0, 0, 0);


		// var dateEnd = Code.getTimeStamp(2021, 6, 1, 0, 0, 0, 0);


		// var dateStart = Code.getTimeStamp(2021, 5, 1, 0, 0, 0, 0);
		// var dateEnd = Code.getTimeStamp(2021, 6, 1, 0, 0, 0, 0);

		// var dateStart = Code.getTimeStamp(2021, 6, 1, 0, 0, 0, 0);
		// var dateEnd = Code.getTimeStamp(2021, 6, 28, 0, 0, 0, 0);


		var dateList = dateListInRange(dateStart,dateEnd);
		var database = loadData();
		console.log(database);
		var databaseAggregate = database["tickers"];
		console.log(databaseAggregate);

		var tables = {};
		for(var i=0; i<tickers.length; ++i){
			var ticker = tickers[i];
			var entry = {};
				entry["id"] = ticker;
				entry["date"] = [];
				entry["price"] = [];
				entry["percent"] = [];
				entry["minPrice"] = null;
				entry["maxPrice"] = null;
				entry["minPercent"] = null;
				entry["maxPercent"] = null;
				entry["base"] = null;
			tables[ticker] = entry;
		}
		// console.log(dateList);
		for(var i=0; i<dateList.length; ++i){
			var date = dateList[i];
			var list = databaseAggregate[date];
			// console.log(list);
			if(list){
				for(var j=0; j<tickers.length; ++j){
					var ticker = tickers[j];
					var table = tables[ticker];
					var base = table["base"];
					var entry = list[ticker];
					if(!entry){
						continue;
					}
					var price = entry["p"]; // 
					var percent = 1.0;
					if(!base){
						base = price;
						table["base"] = base;
						table["minPercent"] = percent;
						table["maxPercent"] = percent;
						table["minPrice"] = price;
						table["maxPrice"] = price;
					}else{
						var percent = price/base;
						table["minPercent"] = Math.min(table["minPercent"],percent);
						table["maxPercent"] = Math.max(table["maxPercent"],percent);
						table["minPrice"] = Math.min(table["minPrice"],price);
						table["maxPrice"] = Math.max(table["maxPrice"],price);
					}
					table["date"].push(i);
					table["percent"].push(percent);
					table["price"].push(price);
					

					// console.log(table);
					// throw "...";
				}
			}
			// var ticker = tickers[i];
			// throw "..."
		}
		// console.log(dateList);

		// fund overall max & min
		var globalMinPrice = null;
		var globalMaxPrice = null;
		var globalMinPercent = null;
		var globalMaxPercent = null;
		for(var i=0; i<tickers.length; ++i){
			var ticker = tickers[i];
			var table = tables[ticker];
			if(!globalMinPrice){
				globalMaxPrice = table["maxPrice"];
				globalMinPrice = table["minPrice"];
				globalMaxPercent = table["maxPercent"];
				globalMinPercent = table["minPercent"];
			}else{
				globalMaxPrice = Math.max(table["maxPrice"],globalMaxPrice);
				globalMinPrice = Math.min(table["minPrice"],globalMinPrice);
				globalMaxPercent = Math.max(table["maxPercent"],globalMaxPercent);
				globalMinPercent = Math.min(table["minPercent"],globalMinPercent);
			}
		}
		var globalRangePrice = globalMaxPrice-globalMinPrice;
		var globalRangePercent = globalMaxPercent-globalMinPercent;
		// console.log(tables);


		// plot
		var width = 2000;
		var height = 1400;
		var display = new DO();
			display.graphics().setFill(0xFFFFFFFF);
			display.graphics().setLine(1.0, 0xFF000000);
			display.graphics().beginPath();
			display.graphics().drawRect(0,0,width,height);
			display.graphics().endPath();
			display.graphics().fill();
			display.graphics().strokeLine();
		GLOBALSTAGE.addChild(display);


		var displayColorMap = [0xFFFF0000, 0xFF990099, 0xFF009999, 0xFF00FF00];
		

		// display.
		for(var i=0; i<tickers.length; ++i){
			var ticker = tickers[i];
			var table = tables[ticker];
			var x = table["date"];
			// PRICE
			// var y = table["price"];
			// var min = table["min"];
			// var max = table["max"];
			// var globalMin = globalMinPrice;
			// var globalMax = globalMaxPrice;
			// var globalRange = globalRangePrice;
			// PERCENT
			var tickerPrice = table["price"];
				tickerPrice = tickerPrice[tickerPrice.length-1];
			var y = table["percent"];
			var min = table["minPercent"];
			var max = table["maxPercent"];
			var globalMin = globalMinPercent;
			var globalMax = globalMaxPercent;
			var globalRange = globalRangePercent;


			// var results = Code.findExtrema1D(y);
			// console.log(results);
			// throw "..."

			var color = null;
			var lineSize = null;


			var last = y[y.length-1];
			var per = ((last-globalMin)/globalRange);

			// var color = 0xFFCC0000;
			// color = Code.getColARGBFromFloat(1.0,Math.random(),Math.random(),Math.random());


			var doBS = true; // buy/sell

			if(doBS){
				color = 0xFFCCCCCC; // default
				lineSize = 1.0;
				var info = positions[ticker];
				if(info){
// console.log(info);
					var buyPrice = info["b"];
					var sellPrice = info["s"];
// console.log(buyPrice,sellPrice,tickerPrice)
					if(buyPrice){
						if(buyPrice>=tickerPrice){
							lineSize = 2.0;
							color = 0xFF009900;
							console.log("BUY: "+ticker+" @ "+buyPrice+" ["+tickerPrice+"]");
						}else if(buyPrice>=tickerPrice*0.98){ // CLOSE
							lineSize = 2.0;
							color = 0xFF99CCCC;
							console.log("   close buy: "+ticker+" @ "+buyPrice+" ["+tickerPrice+"]");
						}
					}
					if(sellPrice){
						if(sellPrice<=tickerPrice){
							lineSize = 2.0;
							color = 0xFFCC0000;
							console.log("SELL: "+ticker+" @ "+sellPrice+" ["+tickerPrice+"]");
						}else if(sellPrice<=tickerPrice*1.02){ // CLOSE
							lineSize = 2.0;
							color = 0xFFFF99CC;
							console.log("   close sell: "+ticker+" @ "+sellPrice+" ["+tickerPrice+"]");
						}
					}
				}
			}else{
				color = Code.interpolateColorGradientARGB(per, displayColorMap);
				lineSize = 1.0;
			}

			display.graphics().setLine(lineSize, color);
			display.graphics().beginPath();
			var lastY = 0;
			var lastValue = 0;
			for(var j=0; j<x.length; ++j){
				var date = x[j];
				var price = y[j];
				lastValue = price;
				var dx = (j/(x.length-1))*width;
				var dy = ((price-globalMin)/globalRange)*height;
				// flip y
				dy = height - dy;
				if(j==0){
					display.graphics().moveTo(dx,dy);
				}else{
					display.graphics().lineTo(dx,dy);
				}
				lastY = dy;
			}
			// display.graphics().endPath();
			display.graphics().strokeLine();
			// if(i%10==0){
			if(true){
				lastValue = Code.fixed(lastValue+"",5);

				var fntSize = 12.0;
				var col = i%40;
				var t = new DOText(""+ticker+"-"+lastValue,fntSize,DOText.FONT_ARIAL,0xFF000099,DOText.ALIGN_LEFT);
					t.matrix().identity();
					t.matrix().translate(width + col*20, lastY + fntSize);
				display.addChild(t);
			}
		}


		/*
		var d = new DO();
this._root.addChild(d);
	var gr = d.graphics();
	gr.clear();
	gr.setFill(0x55FF0077);
	gr.setLine(2.0, 0xCCCC0000);
	gr.beginPath();
	gr.drawRect(50,50, 50,60);
	gr.endPath();
	gr.fill();
	gr.strokeLine();
		*/


		// get all the indexes in the range

		// for each stock ticker:


	}






	// LOAD THE DATA:
	// aggregateData();

	// DISPLAY THE DATA
	plotData();


	// plot 

		// find lowst & highest % change for each ticker, for each day

		//

	// Code.mapArray = function(a,fxn){ // a = b


	// SIGNIFICANT THINGS TO DISPLAY:
		// things that have been down for N days in a row
		// things that have been up for N days in a row
		// things that are at some monthly low / high
			// 1 week low/high
			// 2 week low/high
			// 1 month low/high
			// 3 month low/high
			// 6 month low/high
		// based on previous peak when is a good sell point
		// based on previous tough when is a good buy point

	// doData();




	//
	// var getReleventDataFxnA = function(data){
	// 	// console.log(data);
	// 	var object = Code.parseJSON(data);
	// }
	
	// service.getFullMarketData(2021,6,25,getReleventDataFxn);


/*
T: "PFS" -- ticker
c: 23.88 -- close
h: 23.88 -- high
l: 23.54 -- low
n: 3838 -- transaction count
o: 23.8 -- open
t: 1624651200000 - timestamp start
v: 1520528 - trading volume
vw: 23.8561 - volume weighted avg price
*/
}




Polygon = function(apiKey){
	if(!apiKey){
		throw "no api key";
	}
	this._apiKey = apiKey;
}
Polygon.prototype.getFullMarketData = function(year,month,day, callbackFxn){
	console.log("getFullMarketData");
	var ajax = new Ajax();
	// var date = "2021-06-28";
	var date = ""+Code.prependFixed(""+year,"0",4)+"-"+Code.prependFixed(""+month,"0",2)+"-"+Code.prependFixed(""+day,"0",2);

// date = "2021-06-28";
//         2021-06-27 // WEEKEND
	var url = "https://api.polygon.io/v2/aggs/grouped/locale/us/market/stocks/"+date;
	console.log(date);
	console.log(url);
	ajax.binary(false);
	ajax.method(Ajax.METHOD_TYPE_GET);
	ajax.url(url);
	ajax.params({
		"apiKey":this._apiKey,
		"adjusted":true,
	});
	ajax.callback(callbackFxn);
	ajax.go();
}




</script>
<body onload="pageLoadedFxn();">
</body>
</html>
