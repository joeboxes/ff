<html>
<head>
<title>3DR</title>
<script src="../../code/FF.js"></script>
</head>
<script type="text/javascript">
function pageLoadedFxn(){
	var ff = new FF("../../code/",ffLoadedFxn);
}
function ffLoadedFxn(){
	(new ScriptLoader("./",["App3DR.js", "../SIFTDescriptor.js", "../R3D.js", "../Dense.js"],this,classesLoadedFxn)).load();
}
function classesLoadedFxn(){
	var t = new Tensor([3,3,3]);
	console.log(t);
	console.log(t+"");
	console.log("FR ");
	var a = [];
	for(var i=0; i<27; ++i){
		a[i] = i;
	}
	t.fromArray(a);
	console.log("TO ");
	console.log(t.toArray());
	console.log("GET ");
	console.log(t.get([0,1,2]));

	console.log("SET ");
	console.log(t.set([0,1,2], 99));

	console.log("SET ");
	console.log(t.set([2,2,2], 0));

	console.log("TO ");
	console.log(t.toArray());
	return;
/*
	var pointsA = [
				new V2D(86,208), // glasses corner left
				new V2D(190,180), // glasses corner right
				new V2D(172,107), // origin
				new V2D(22.5,166), // lighter button
				new V2D(361,183), // mouse eye
				new V2D(18,225), // bic corner left
				new V2D(37,216), // bic corner right
				new V2D(65,169), // cup 
				new V2D(226,87), // face BL
				new V2D(219,66), // glasses TL
				new V2D(250,72), // glasses TR
				new V2D(260,103), // elbow
				new V2D(216,154), // toe left
				new V2D(245,158), // toe right
				new V2D(202,127), // brick
				new V2D(240,248), // 12
				new V2D(332,249), // 16
				new V2D(145,203), // glasses center
				new V2D(172,68), // grid top
				new V2D(141,76), // grid TL
				new V2D(204,75), // grid TR
				new V2D(144,119), // grid BL
				new V2D(175,128), // grid bot
				new V2D(362,213), // U
				new V2D(326,176), // tail
				new V2D(190,173), // base left
				new V2D(265,178), // base right
				new V2D(372,181), // nose
				new V2D(129,88), // power top
				new V2D(132,141), // power bot
				new V2D(62,107), // cup
				new V2D(94,176), // glass tip left
				new V2D(131,166), // glass tip right
			];
var pointsB = [
				new V2D(87,192),
				new V2D(170,178),
				new V2D(212,46),
				new V2D(50,149),
				new V2D(278,241),
				new V2D(52,179), // left
				new V2D(64,172), // right//new V2D(18,225), // right
				new V2D(94,124), 
				new V2D(225,98), // face BL
				new V2D(221,80), // glasses TL
				new V2D(246,95), // glasses TR
				new V2D(250,121),
				new V2D(214,139), // tow left
				new V2D(237,150), // toe right
				new V2D(213,106), // brick
				new V2D(180,252), // 12
				new V2D(245,271), // 16
				new V2D(131,193), // glasses center
				new V2D(213,12), // grid top
				new V2D(177,26), // grid TL
				new V2D(239,33), // grid TR
				new V2D(180,61), // grid BL
				new V2D(202,83), // grid bot
				new V2D(282,251), // U
				new V2D(256,225), // tail
				new V2D(187,153), // base left
				new V2D(245,173), // base right
				new V2D(290,240), // nose
				new V2D(150,63), // power top
				new V2D(155,100), // power bot
				new V2D(85,92), // cup
				new V2D(113,138), // glass tip left
				new V2D(145,132), // glass tip right
			];
var pointsAin = pointsA;
var pointsBin = pointsB;

	var pointsA = [];
	var pointsB = [];
	for(i=0; i<pointsAin.length; ++i){
		pointsA[i] = new V3D(pointsAin[i].x,pointsAin[i].y,1.0);
		pointsB[i] = new V3D(pointsBin[i].x,pointsBin[i].y,1.0);
	}
	
	var pointsANorm = R3D.calculateNormalizedPoints([pointsA]);
	var pointsBNorm = R3D.calculateNormalizedPoints([pointsB]);
	var pA = pointsANorm.normalized[0];
	var pB = pointsBNorm.normalized[0];

	

	var Fnrm = R3D.fundamentalMatrix(pA,pB);
	var Floc = Fnrm.copy();
	Floc = Matrix.mult(Floc, pointsANorm.forward[0]);
	Floc = Matrix.mult(Matrix.transpose(pointsBNorm.forward[0]), Floc);

	console.log(Floc+"");


	var error = R3D._gdFun([pointsA,pointsB], Floc.toArray(), false);
	var averageError = error/pointsA.length;
	console.log("1 F AVG ERROR: "+error+" == "+averageError);
var errorA = averageError;


	
	
	var Fnext = Fnrm;
	//var Fnext = R3D.fundamentalMatrixNonlinearGD(Fnrm, pA, pB);
	//Fnext = R3D.forceRank2F(Fnext);

	for(i=0; i<3; ++i){
		//console.log("LM");
		Fnext = R3D.fundamentalMatrixNonlinearLM(Fnext, pA, pB);
		//console.log("GD");
		Fnext = R3D.fundamentalMatrixNonlinearGD(Fnext, pA, pB);
	}

//	Fnext = R3D.fundamentalMatrixNonlinearGD(Fnext, pA, pB);
// }catch(e){
// 	console.log("??? "+e);
// }
	//Fnext = R3D.forceRank2F(Fnext);

	// GD: 0.8771833241544938
	// LM: 0.9928658790461447
	// GD+LM: 0.87718
	// LM+GD: 0.876840
	// 2x.  : 0.8727416521415238
	// 10x. : 0.871342
	// 0.8702023724746977
	//Fnext = R3D.forceRank2F(Fnext);
	//  0.8711342044146368
	Floc = Fnext.copy();
	Floc = Matrix.mult(Floc, pointsANorm.forward[0]);
	Floc = Matrix.mult(Matrix.transpose(pointsBNorm.forward[0]), Floc);
	console.log(Floc+"");




	var error = R3D._gdFun([pointsA,pointsB], Floc.toArray(), false);
	var averageError = error/pointsA.length;
	console.log("2 F AVG ERROR: "+error+" == "+averageError);
var errorB = averageError;
	
	console.log(" DELTA ERROR: "+(errorB/errorA));
	return;
*/


/*
	console.log(Code.appendToPath("a","b","c") );
	console.log(Code.appendToPath("a","b") );
	console.log(Code.appendToPath("/","a") );
	console.log(Code.appendToPath("/","a/") );
	console.log(Code.appendToPath("/","/a/","/b/") );
	return;
*/
	//var client = new ClientFile();
	// http://localhost/ff/3DR/app/app.html
	/*
	var text = "test string to save\nto a file";
	var binary = Code.stringToBinary(text);
	console.log(text);
	console.log(binary);
	client.set("test.txt", binary);
	return;
	*/



// var client = new ClientFile();
// 	client.del("projects/0/MZT6OFNF/50.png");
// 	return;
	// var client = new ClientFile();
	// client.set("projects/0");
	// return;
	

// 	client.get("projects/test1.png");
// return;
	//client.get("images/background.php");
	//client.get("test.png");
	//client.get("test3.png");
	//client.get("test5.png");
	//client.get("/");
/*
	var base64 = "iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAAaElEQVR4nO3VMQqAQBAEwVnx/18+c9esQSboDpcLCkFmkpy8OmedMjPr9se7a13KEkirB95NP8TXu/ovKJBWD5y4JCyBtHqgS0ITSKsHuiQ0gbR6oEtCE0irB7okNIG0eqBLQhNIqwc+4L9kRXekVq0AAAAASUVORK5CYII=";
	console.log(base64);
	var binary = Code.base64StringToBinary(base64);
	//console.log(binary);
	console.log(binary);
	console.log(Code.binaryToBase64String(binary));

	//client.set("upload.png",binary);
	//client.set("projects");
	client.set("projects/test1.png", binary);
*/
	//client.del("projects/test1.png");
	//client.del("/projects");

//	return;
/*
	var pointsA = [];
	var pointsB = [];
	for(var i=0; i<3; ++i){
		var p = new V2D( Code.randomFloat(-1,1), Code.randomFloat(-1,1) );
		pointsA.push(p);
		var p = new V2D( Code.randomFloat(-1,1), Code.randomFloat(-1,1) );
		pointsB.push(p);
	}
	
	var pointsA = [new V2D( 2, 3),new V2D(6,4),new V2D(3,6)];
	//var pointsB = [new V2D(-1,-1),new V2D(1,0),new V2D(2,3)];
	var pointsB = [new V2D(-1,-1),new V2D(1,0),new V2D(2,-3)];
	
	var m = R3D.affineMatrixExact(pointsA,pointsB);
	var n = R3D.affineMatrixExact(pointsB,pointsA);

	var pointsC = [];
	var pointsD = [];
	for(var i=0; i<pointsA.length; ++i){
		var pA = pointsA[i];
		var pB = pointsB[i];
		var pC = m.multV2DtoV2D(new V2D(), pA);
		var pD = n.multV2DtoV2D(new V2D(), pB);
		if(false){
		if(i==0){
			pA = new V2D(0,0);
			pB = pA;
		}else if(i==1){
			pA = new V2D(1,0);
			pB = pA;
		}else if(i==2){
			pA = new V2D(0,1);
			pB = pA;
		}
		}
		var diffA = V2D.distance(pA,pD);
		var diffB = V2D.distance(pB,pC);
		pointsC.push(pC);
		pointsD.push(pD);
		console.log(diffA+" | "+diffB);
	}
	console.log("A: "+pointsA+"");
	console.log("B: "+pointsB+"");
	console.log("C: "+pointsC+"");
	console.log("D: "+pointsD+"");

	return;
*/
	var app = new App3DR();
}
</script>
<body onload="pageLoadedFxn();" style="padding:0; margin:0; border:0;">
</body>
</html>
