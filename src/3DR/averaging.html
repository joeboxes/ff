<html>
<head>
<title>Averaging</title>
<script src="../code/FF.js"></script>
</head>
<script type="text/javascript">
function pageLoadedFxn(){
	var ff = new FF("../code/",ffLoadedFxn);
}
function ffLoadedFxn(){
	(new ScriptLoader("./",["R3D.js"],this,classesLoadedFxn)).load();
}
function classesLoadedFxn(){
	// counts 1D
	console.log("--- counts 1D");
	//              0     1    2    3    4     5    6    7
	var counts = [1.0, 1.25, 2.5, 4.4, 10.0, 3.0, 2.0, 1.0];
	var edges = [ [0,1], [0,2], [1,3], [2,4], [2,5], [3,4], [4,5], [5,6], [5,7], [6,7] ];
	var errorMagnitude = 0.1;
	for(var i=0; i<edges.length; ++i){
		var edge = edges[i];
		var error = errorMagnitude*Math.random();
		var delta = error*(Math.random()-0.5);
		var valueA = counts[edge[0]];
		var valueB = counts[edge[1]];
		var valueAB = valueB - valueA;
			valueAB += delta;
		edge[2] = valueAB;
		edge[3] = error;
	}
	var min = Code.min(counts);
	var result = Code.graphAbsoluteFromRelative1D(edges);
	var values = result["values"];
	for(var i=0; i<counts.length; ++i){
		console.log(" "+i+" : "+counts[i]+" =?= "+(values[i] + min));
	}


	// scales 1D
	console.log("--- scales 1D");
	//              0     1    2    3    4     5    6    7
	var scales = [1.0, 1.25, 2.5, 4.4, 10.0, 3.0, 2.0, 1.0];
	var edges = [ [0,1], [0,2], [1,3], [2,4], [2,5], [3,4], [4,5], [5,6], [5,7], [6,7] ];
	var errorMagnitude = 0.1;
	for(var i=0; i<edges.length; ++i){
		var edge = edges[i];
		var error = errorMagnitude*Math.random();
		var delta = error*(Math.random()-0.5);
		var valueA = counts[edge[0]];
		var valueB = counts[edge[1]];
		var valueAB = Math.log(valueB/valueA) + delta;
			valueAB = Math.exp(valueAB);
			valueAB = Math.log(valueAB); // LOG SPACE
		edge[2] = valueAB;
		edge[3] = error;
	}
	var min = Code.min(scales);
	var result = Code.graphAbsoluteFromRelative1D(edges);
	var values = result["values"];
	for(var i=0; i<scales.length; ++i){
		console.log(" "+i+" : "+scales[i]+" =?= "+(Math.exp(values[i])) );
	}

	// positions 2D
	console.log("--- positions 2D");
	//                         0             1             2             3             4             5             6             7
	var positions = [new V2D(1,2), new V2D(3,5), new V2D(4,1), new V2D(6,2), new V2D(5,4), new V2D(7,7), new V2D(6,2), new V2D(5,0) ];
	var edges = [ [0,1], [0,2], [1,3], [2,4], [2,5], [3,4], [4,5], [5,6], [5,7], [6,7] ];
	var errorMagnitude = 0.1;
	for(var i=0; i<edges.length; ++i){
		var edge = edges[i];
		var error = errorMagnitude*Math.random();
		var delta = V2D.random(error);
		var valueA = positions[edge[0]];
		var valueB = positions[edge[1]];
		var valueAB = V2D.sub(valueB,valueA);
			valueAB.add(delta);
		edge[2] = valueAB;
		edge[3] = error;
	}
	var result = Code.graphAbsoluteFromRelativeV2D(edges);
	var values = result["values"];
	var min = V2D.sub(values[0],positions[0]);
	for(var i=0; i<positions.length; ++i){
		console.log(" "+i+" : "+positions[i]+" =?= "+V2D.sub(values[i],min) );
	}

	// positions 3D
	var positions = [new V3D(1,2,0), new V3D(3,5,1), new V3D(4,1,2), new V3D(6,2,1), new V3D(5,4,0), new V3D(7,7,2), new V3D(6,2,0), new V3D(5,0,3) ];
	var edges = [ [0,1], [0,2], [1,3], [2,4], [2,5], [3,4], [4,5], [5,6], [5,7], [6,7] ];
	var errorMagnitude = 0.1;
	for(var i=0; i<edges.length; ++i){
		var edge = edges[i];
		var error = errorMagnitude*Math.random();
		var delta = V3D.random(error);
		var valueA = positions[edge[0]];
		var valueB = positions[edge[1]];
		var valueAB = V3D.sub(valueB,valueA);
			valueAB.add(delta);
		edge[2] = valueAB;
		edge[3] = error;
	}
	var result = Code.graphAbsoluteFromRelativeV3D(edges);
	var values = result["values"];
	var min = V3D.sub(values[0],positions[0]);
	for(var i=0; i<positions.length; ++i){
		console.log(" "+i+" : "+positions[i]+" =?= "+V3D.sub(values[i],min) );
	}

	// orientations 2D
	console.log("--- orientations/angles 2D");
	//                          0                 1                  2                 3                  4                 5                 6                 7
	var angles = [Code.radians(10), Code.radians(-20), Code.radians(30), Code.radians(50), Code.radians(-10), Code.radians(25), Code.radians(10), Code.radians(20)];
	var edges = [ [0,1], [0,2], [1,3], [2,4], [2,5], [3,4], [4,5], [5,6], [5,7], [6,7] ];
	var errorMagnitude = 0.1;
	for(var i=0; i<edges.length; ++i){
		var edge = edges[i];
		var error = errorMagnitude*Math.random();
		var delta = error*(Math.random()-0.5);
		var valueA = angles[edge[0]];
		var valueB = angles[edge[1]];
		var valueAB = Code.angleDirection(valueA,valueB);
			valueAB += delta;
		edge[2] = valueAB;
		edge[3] = error;
	}
	var result = Code.graphAbsoluteFromRelativeAngle2D(edges);
	var values = result["values"];
	var min = Code.angleDirection(angles[0],values[0]);
	console.log(min);
	for(var i=0; i<angles.length; ++i){
		console.log(" "+i+" : "+Code.degrees(Code.angleZeroTwoPi(angles[i]))+" =?= "+Code.degrees(Code.angleZeroTwoPi(values[i]-min)) );
	}

	// angles 3d
	console.log("--- angles 3D");
	var m, t, q;
m = new Matrix3D(); m.rotateZ(Code.radians(10.0)); m.rotateX(Code.radians(10.0));  m.rotateY(Code.radians( 10.0));
var same = m;
// console.log(same+"")
	var orientations = [];
		m = new Matrix3D(); m.rotateZ(Code.radians(20.0)); m.rotateX(Code.radians(-20.0));  m.rotateY(Code.radians( 20.0)); orientations.push( m ); // 0
		m = new Matrix3D(); m.rotateZ(Code.radians(-10.0)); m.rotateX(Code.radians(10.0));  m.rotateY(Code.radians( 10.0)); orientations.push( m ); // 1
		m = new Matrix3D(); m.rotateZ(Code.radians(10.0)); m.rotateX(Code.radians( 20.0));  m.rotateY(Code.radians(-10.0)); orientations.push( m ); // 2
		m = new Matrix3D(); m.rotateZ(Code.radians(25.0)); m.rotateX(Code.radians(-10.0));  m.rotateY(Code.radians( 30.0)); orientations.push( m ); // 3
		m = new Matrix3D(); m.rotateZ(Code.radians(30.0)); m.rotateX(Code.radians( 30.0));  m.rotateY(Code.radians( 40.0)); orientations.push( m ); // 4
		m = new Matrix3D(); m.rotateZ(Code.radians(50.0)); m.rotateX(Code.radians( 20.0));  m.rotateY(Code.radians( 20.0)); orientations.push( m ); // 5
		m = new Matrix3D(); m.rotateZ(Code.radians(30.0)); m.rotateX(Code.radians( 10.0));  m.rotateY(Code.radians( 60.0)); orientations.push( m ); // 6
		m = new Matrix3D(); m.rotateZ(Code.radians(10.0)); m.rotateX(Code.radians( 30.0));  m.rotateY(Code.radians( 50.0)); orientations.push( m ); // 7
	var edges = [ [0,1], [0,2], [1,3], [2,4], [2,5], [3,4], [4,5], [5,6], [5,7], [6,7] ];
	var errorMagnitude = 0.000001;
	for(var i=0; i<edges.length; ++i){
		var edge = edges[i];
		var error = errorMagnitude*Math.random();
		var delta = error*(Math.random()-0.5);
		var valueA = orientations[edge[0]];
		var valueB = orientations[edge[1]];
		var valueAB = Matrix3D.relative(valueA,valueB);
		// random quaternion - orientation
		var q = new V4D();
			q.qIdentity();
		var v = new V3D();
			v.random(2,2,2);
			v.norm();
			q.qRotateDir(v.x,v.y,v.z, delta);
		// apply error
		var m = q.qMatrix();
		valueAB.mult(m);
		// to vector:
		valueAB = valueAB.multV3DtoV3D(new V3D(0,0,1));
		valueAB.norm();
		edge[2] = valueAB;
		edge[3] = error;
	}
	console.log(edges);

	// CONVERT:
	var sames = [];
	for(var i=0; i<orientations.length; ++i){
		var m = orientations[i];
		orientations[i] = m.multV3DtoV3D(new V3D(0,0,1));
		// console.log(" "+i+" = "+orientations[i]+" | "+orientations[i].length());
			m = Matrix3D.mult(same,m);
		sames[i] = m.multV3DtoV3D(new V3D(0,0,1));
	}

	console.log(orientations);

	var result = Code.graphAbsoluteFromRelativeAngle3D(edges);
	console.log(result);
	var values = result["values"];

values = sames;

	var dirOA = orientations[0];
	var dirOB = orientations[1];
	var dirVA = values[0];
	var dirVB = values[1];
	var dir0 = V3D.cross(dirOA,dirVA);
		dir0.norm();
	var ang0 = V3D.angle(dirOA,dirVA);

		dirVB = V3D.rotateAngle(dirVB, dir0,-ang0);
	// var dir1 = V3D.cross(dirA,dirC);
	// 	dir1.norm();
	// var ang1 = V3D.angle(dirA,dirC);

	var ang1 = Code.radians(-25);

	for(var i=0; i<orientations.length; ++i){
		var a = orientations[i];
		var b = values[i];
			// OFFSET
			b = V3D.rotateAngle(b, dir0,-ang0);
			// b = V3D.rotateAngle(b, dirOA,-ang1);

		var diff = V3D.angle(a,b);
		console.log(" "+i+" : "+Code.degrees(diff)+" =?= "+a+" & "+b);
		// console.log("             "+a+" , "+b);
		// console.log(" "+i+" : "+Code.degrees(Code.angleZeroTwoPi())+" =?= "+Code.degrees(Code.angleZeroTwoPi(-min)) );
	}

	throw "?"

	// orientations 3d
	console.log("--- orientation 3D");
	//                          0                 1                  2                 3                  4                 5                 6                 7
	var m, t, q;
	var orientations = [];
		m = new Matrix3D(); m.rotateZ(Code.radians(20.0)); m.rotateX(Code.radians(-20.0));  m.rotateY(Code.radians( 20.0)); orientations.push( m ); // 0
		m = new Matrix3D(); m.rotateZ(Code.radians(-10.0)); m.rotateX(Code.radians(10.0));  m.rotateY(Code.radians( 10.0)); orientations.push( m ); // 1
		m = new Matrix3D(); m.rotateZ(Code.radians(10.0)); m.rotateX(Code.radians( 20.0));  m.rotateY(Code.radians(-10.0)); orientations.push( m ); // 2
		m = new Matrix3D(); m.rotateZ(Code.radians(25.0)); m.rotateX(Code.radians(-10.0));  m.rotateY(Code.radians( 30.0)); orientations.push( m ); // 3
		m = new Matrix3D(); m.rotateZ(Code.radians(30.0)); m.rotateX(Code.radians( 30.0));  m.rotateY(Code.radians( 40.0)); orientations.push( m ); // 4
		m = new Matrix3D(); m.rotateZ(Code.radians(50.0)); m.rotateX(Code.radians( 20.0));  m.rotateY(Code.radians( 20.0)); orientations.push( m ); // 5
		m = new Matrix3D(); m.rotateZ(Code.radians(30.0)); m.rotateX(Code.radians( 10.0));  m.rotateY(Code.radians( 60.0)); orientations.push( m ); // 6
		m = new Matrix3D(); m.rotateZ(Code.radians(10.0)); m.rotateX(Code.radians( 30.0));  m.rotateY(Code.radians( 50.0)); orientations.push( m ); // 7
	// convert to twists:
	// for(var i=0; i<orientations.length; ++i){
	// 	var m = orientations[i];
	// 	// console.log(m);
	// 	q = V4D.qFromMatrix(m);
	// 	// console.log(q);
	// 	t = Code.vectorTwistFromQuaternion(q);
	// 	// console.log(t);
	// 	orientations[i] = t;
	// }
	var edges = [ [0,1], [0,2], [1,3], [2,4], [2,5], [3,4], [4,5], [5,6], [5,7], [6,7] ];
	var errorMagnitude = 0.5;
	for(var i=0; i<edges.length; ++i){
		var edge = edges[i];
		var error = errorMagnitude*Math.random();
		var delta = error*(Math.random()-0.5);
		var valueA = orientations[edge[0]];
		var valueB = orientations[edge[1]];
		// console.log(valueA+"");
		// console.log(valueB+"");
		// console.log("...........................");
		// valueA = valueA.toMatrix();
		// valueB = valueB.toMatrix();
		var valueAB = Matrix3D.relative(valueA,valueB);
		// console.log(valueAB+"");
// var R = R3D.relativeTransformMatrix2(valueA.toMatrix(),valueB.toMatrix());
// console.log(R+"");
// console.log("???????????????????");
// console.log( Matrix3D.inverse(valueA)+"" );
// console.log( Matrix.inverse(valueA.toMatrix())+"" );
// console.log("???????????????????");
		// random quaternion - orientation
		var q = new V4D();
			q.qIdentity();
		var v = new V3D();
			v.random(2,2,2);
			v.norm();
			q.qRotateDir(v.x,v.y,v.z, delta);
		// apply error
		var m = q.qMatrix();
		valueAB.mult(m);
		// console.log(m+"");
		// console.log(valueAB+"");
		// console.log(valueAB.toMatrix());
		// throw "?"
		edge[2] = valueAB.toMatrix();
		edge[3] = error;
	}
	var result = Code.graphAbsoluteFromRelativeOrientation3D(edges);
	console.log(result);
	var values = result["values"];
	var min = Code.angleDirection(orientations[0],values[0]);
	console.log(min);
	for(var i=0; i<orientations.length; ++i){
		console.log(" "+i+" : "+Code.degrees(Code.angleZeroTwoPi(angles[i]))+" =?= "+Code.degrees(Code.angleZeroTwoPi(values[i]-min)) );
	}


	// pose 2D
	console.log("--- pose 2D");
	//                         0             1             2             3             4             5             6             7
	// var positions = [new V2D(1,2), new V2D(3,5), new V2D(4,1), new V2D(6,2), new V2D(5,4), new V2D(7,7), new V2D(6,2), new V2D(5,0) ];
	// var edges = [ [0,1], [0,2], [1,3], [2,4], [2,5], [3,4], [4,5], [5,6], [5,7], [6,7] ];
	// var errorMagnitude = 0.1;
	// Code.graphAbsoluteFromRelativePose2D



	// pose 3D
	console.log("--- pose 3D");
	//                         0             1             2             3             4             5             6             7
	



	// m = new Matrix3D(); m.rotateZ(Code.radians(20.0)); m.rotateX(Code.radians(-20.0));  m.rotateY(Code.radians(20.0));
	// console.log(m);
	// q = V4D.qFromMatrix(m);
	// console.log(q);
	// t = Code.vectorTwistFromQuaternion(q);
	// console.log(t);


	throw "...";
}

</script>
<body onload="pageLoadedFxn();">
</body>
</html>
