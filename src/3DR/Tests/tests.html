<html>
<head>
<title>Tests</title>
<script src="../../code/FF.js"></script>
</head>
<script type="text/javascript">
function pageLoadedFxn(){
	var ff = new FF("../../code/",ffLoadedFxn);
}
function ffLoadedFxn(){
	(new ScriptLoader("../",["R3D.js","app/Stereopsis.js"],this,classesLoadedFxn)).load();
}
function classesLoadedFxn(){
	// 
	// testExtraction();
	// testLocalize();
	// testCorners();
	// testLocationSeparate();

	// testBagOfWordMatches();

	// testRIFTMatches(); // INITIAL F

	testRMatches();

	// testLocationNeighborsSparse(); // get better F by using local affine matrix


	// testLocationNeighborsDense();


	// throw "tests";
}

function setupDisplay(){
	this._canvas = new Canvas(null,1,1,Canvas.STAGE_FIT_FILL);
	this._stage = new Stage(this._canvas, (1/5)*1000);
	this._canvas.addListeners();
	this._stage.addListeners();
	this._stage.start();
	this._root = new DO();
	this._stage.root().addChild(this._root);
// this._root.matrix().scale(2.0,2.0);
this._stage.root().matrix().scale(1.0);
// this._stage.root().matrix().scale(2.0);
// this._stage.root().matrix().scale(2.5);
// this._stage.root().matrix().scale(4.0);
	GLOBALSTAGE = this._stage;
}


function testRMatches(){
	// R3D.differentialCornersForImageSingle = function(imageMatrix, suppressDistancePercent){
		setupDisplay();
	var fxnImageLoaded = function(info){
		console.log("fxnImageLoaded")
		var images = info["images"];
		var imageScalesList = [];
		var objectsList = [];
		for(var iii=0; iii<images.length; ++iii){
			var image = images[iii];
			var imageFloat = GLOBALSTAGE.getImageAsFloatRGB(image);
			var imageMatrix = new ImageMat(imageFloat["width"],imageFloat["height"], imageFloat["red"], imageFloat["grn"], imageFloat["blu"]);

			var imageScales = new ImageMatScaled(imageMatrix);
			imageScalesList.push(imageScales);

			// image = imageScales.images()[0];
			// var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
			// var d = new DOImage(img);
			// d.matrix().scale(1.0);
			// d.matrix().translate(0 + iii*imageMatrix.width(), 0 + 0);
			// GLOBALSTAGE.addChild(d);
		}

		var imageScalesA = imageScalesList[0];
		var imageScalesB = imageScalesList[1];

		console.log(imageScalesA);
		console.log(imageScalesB);


		var cellCount = 40;
		var cellSize = R3D.cellSizingRoundWithDimensions(imageScalesA.width(),imageScalesA.height(),cellCount, false);
		console.log("cellSize: "+cellSize);

		
		var I = new Matrix(4,4).identity();
		var P = new Matrix(4,4).fromArray([0.9770374617683517,0.12151833684795876,-0.1750174051657801,0.38263828079058476,-0.10651704232675788,0.989977455761452,0.09272948170911947,-0.23235876684933934,0.18453161787405561,-0.07195784108621019,0.980188834414571,-0.03538447860527381,0,0,0,1]);
		var K = new Matrix(3,3).fromArray([0.8416110193263069,-0.00037245040438613555,0.4987416183797266, 0,1.1206454954519742,0.49539092201719453, 0,0,1]);
		var distortion = null;

		/*
		var world = new Stereopsis.World();
		var camera = world.addCamera(K, distortion);
		var viewA = world.addView(imageScalesA, camera);
		var viewB = world.addView(imageScalesB, camera);
		viewA.cellSize(cellSize);
		viewB.cellSize(cellSize);

		viewA.absoluteTransform(I);
		viewB.absoluteTransform(P);
		console.log(world);

		world.solveDensePair();
		*/

		var Kimage = R3D.cameraFromScaledImageSize(K, imageScalesA.size());
		var result = R3D.searchMatchPointsPair3D(imageScalesA,imageScalesB, P, Kimage,Kimage); // forward
		// var result = R3D.searchMatchPointsPair3D(imageScalesB,imageScalesA, Matrix.inverse(P), K,K); // inverse
		console.log(result);
		var pointsA = result["A"];
		var pointsB = result["B"];
		var affinesAB = result["affines"];


		console.log(pointsA);
		console.log(pointsB);


		var world = new Stereopsis.World();
		var camera = world.addCamera(K, distortion);
		var viewA = world.addView(imageScalesA, camera);
		var viewB = world.addView(imageScalesB, camera);
		viewA.cellSize(cellSize);
		viewB.cellSize(cellSize);

		viewA.absoluteTransform(I);
		viewB.absoluteTransform(P);
		console.log(world);

		// new points
		var points3DAdd = [];
		var errorsR = [];
		for(var j=0; j<pointsA.length; ++j){
			var p2DA = pointsA[j];
			var p2DB = pointsB[j];
			var affineAB = affinesAB[j];
			var newMatch = world.newMatchFromInfo(viewA,p2DA.copy(),viewB,p2DB.copy(),affineAB);
			points3DAdd.push(newMatch.point3D());
		}
		console.log(points3DAdd);

		// create seed points:
		world.setResolutionProcessingModeFromCountP3D([]); // currently 0
		world.shouldValidateMatchRange(true);
		world.copyRelativeTransformsFromAbsolute();

		// add
		world.initPoints3DLocation(points3DAdd);
		world.initAllP3DPatches(points3DAdd);
		world.initAffineFromP3DPatches(points3DAdd);
		world.embedPoints3D(points3DAdd);

		// solve
		world.solveDensePairNew();


		// var imageSizeA = imageMatrixA.size();
		// var views = [viewA,viewB,viewC];
		// var images = [imageMatrixA,imageMatrixB,imageMatrixC];



		/*

		console.log("fillInWorldAll");
console.log(allCameras);
		var info = project.fillInWorldAll(allViews, cellSize, allCameras);
		var WORLDCAMS = info["cameras"];
		var WORLDVIEWS = info["views"];
		var WORLDVIEWSLOOKUP = info["lookup"];
		var world = info["world"];

		console.log("solveDensePair");
// console.log(info);
// throw "before solveDensePair"
		world.solveDensePair();
		*/
	}
	new ImageLoader("../images/rabbit/",["7.jpg","9.jpg"],this,fxnImageLoaded).load();
}

function testBagOfWordMatches(){
	setupDisplay();
	var fxnImageLoaded = function(info){
		console.log("testBagOfWordMatches")
		var images = info["images"];
		var imageScalesList = [];
		var objectsList = [];
		var idealSize = new V2D(400,300); // 350-400
		// var idealSize = new V2D(600,400); // 650-700
		// var idealSize = new V2D(800,600);
console.log("images: "+images.length);
		var featuresList = [];
		var histogramList = [];
		for(var iii=0; iii<images.length; ++iii){
			var image = images[iii];
			var imageFloat = GLOBALSTAGE.getImageAsFloatRGB(image);
			var imageMatrix = new ImageMat(imageFloat["width"],imageFloat["height"], imageFloat["red"], imageFloat["grn"], imageFloat["blu"]);

			var imageScales = new ImageMatScaled(imageMatrix);
			imageScalesList.push(imageScales);
/*
			image = imageScales.images()[0];
			var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
			var d = new DOImage(img);
			d.matrix().scale(1.0);
			d.matrix().translate(0 + iii*imageMatrix.width(), 0 + 0);
			GLOBALSTAGE.addChild(d);

			// FULL IMAGE HISTOGRAM
			var sampleDimension = 100; // ~ 100x100 = 1E4
			var samplePixelCount = sampleDimension*sampleDimension;
			var imagePixelCount = imageScales.width()*imageScales.height();
			var sampleImageScale = Math.sqrt(samplePixelCount/imagePixelCount);
			console.log("sampleImageScale: "+sampleImageScale);
			var sampleMatrix = imageScales.getScaledImage(sampleImageScale,true);
			// 10x10x10 = MAXIMUM of 1000 entries -- more like 10-100
			var info = R3D.imageHistogramSamples(sampleMatrix);
			console.log(info);
			histogram = info["histogram"];
			histogramList.push(histogram);

			// SAMPLE WORDS:
			var blobs = R3D.SIFTBlobsForImageTest(imageScales, idealSize);
			// console.log(blobs);


			

// var nonMaximalPercent = 0.03; // 0.02 [700] - 0.03 [350] - 0.05 [100]
// var nonRepeatPercent = 0.010;
// var corners = R3D.optimalCountFeaturesFromImageScales(imageScales, nonMaximalPercent, nonRepeatPercent);
// // console.log(corners);
// var features = R3D.colorGradientFeaturesFromPoints(corners,imageScales);
// // console.log(features);
// var blobs = features;
// // console.log(blobs);



			var d = new DO();
			d.graphics().setLine(1.0,0xFFFF0000); 
			for(var b=0; b<blobs.length; ++b){
				var blob = blobs[b];
				var point = blob["point"];
				var size = blob["size"];
				// console.log(blob)
				d.graphics().beginPath();
				d.graphics().drawCircle(point.x,point.y,size);
				d.graphics().endPath();
				d.graphics().strokeLine();
			}
			d.matrix().translate(iii*imageMatrix.width(),0);
			GLOBALSTAGE.addChild(d);

			var features = R3D.bagOfWordsFeaturesHistograms(imageScales,blobs,1.0);
			featuresList.push(features);
*/

		}

		var result = R3D.sequentialImageMatchingLexigramGenerate(imageScalesList);
		console.log(result);
		var histograms = result["histograms"];
		var features = result["features"];
		var result = R3D.sequentialImageMatchingLexigramEvaluate(histograms, features);
		console.log(result);

		var compareScores = result["matches"];

		// throw "here"

		// console.log(histogramList);
		// console.log(featuresList);


		// var featuresA = featuresList[0];
		// var featuresB = featuresList[1];
		// var featuresC = featuresList[2];
		/*
		for(var i=1; i<featuresList.length; ++i){
			var featuresA = featuresList[0];
			var featuresB = featuresList[i];
			var result = R3D.bagOfWordsFeaturesCompare(featuresA,featuresB);
			// console.log(result);
		}
		*/

/*
		var compareScores = [];
		for(var i=0; i<featuresList.length; ++i){
			compareScores[i] = Code.newArrayZeros(featuresList.length);
		}
		for(var i=0; i<featuresList.length; ++i){
			var featuresA = featuresList[i];
			for(var j=i+1; j<featuresList.length; ++j){
				console.log(" : "+i+"-"+j)
				var featuresB = featuresList[j];
				var result = R3D.bagOfWordsFeaturesCompare(featuresA,featuresB);
				// console.log(result);
				var scoreA = result["scoreA"];
				var scoreB = result["scoreB"];
				compareScores[i][j] = scoreA;
				compareScores[j][i] = scoreB;
			}
		}

		console.log(compareScores);
*/
		// display relative scores in CIRCLE ...


		R3D.debugDisplaySimilarities(imageScalesList,compareScores);




		// var result = R3D.bagOfWordsFeaturesCompare(featuresA,featuresC);
		// console.log(result);

		throw "?"

		// console.log(imageScales);
	}
	// new ImageLoader("../images/iowa/",["0.JPG","1.JPG"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/iowa/",["2.JPG","3.JPG"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/iowa/",["4.JPG","5.JPG"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/iowa/",["6.JPG","7.JPG"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/iowa/",["8.JPG","9.JPG"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/iowa/",["0.JPG","1.JPG"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/iowa/",["0.JPG","1.JPG","2.JPG"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/iowa/",["0.JPG","1.JPG","2.JPG","3.JPG"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/iowa/",["0.JPG","1.JPG","2.JPG","3.JPG","4.JPG","5.JPG"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/iowa/",["0.JPG","1.JPG","2.JPG","3.JPG","4.JPG","5.JPG","6.JPG","7.JPG","8.JPG","9.JPG"],this,fxnImageLoaded).load();



	// new ImageLoader("../images/rabbit/",["1.jpg","2.jpg","3.jpg","4.jpg","5.jpg"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/rabbit/",["1.jpg","2.jpg","3.jpg","4.jpg","5.jpg","6.jpg","7.jpg","8.jpg","9.jpg","10.jpg","11.jpg"],this,fxnImageLoaded).load();

	new ImageLoader("../images/",["bench_A.png","bench_B.png","bench_C.png","bench_D.png","bench_E.png","bench_F.png"],this,fxnImageLoaded).load();

	// new ImageLoader("../images/",["castle.000.jpg","castle.009.jpg","castle.018.jpg","castle.027.jpg"],this,fxnImageLoaded).load();

	 // new ImageLoader("../images/",["medusa_1.png","medusa_2.png","medusa_3.png","medusa_4.png","medusa_5.png"],this,fxnImageLoaded).load();

	 // new ImageLoader("../images/",["room0.png","room1.png","room2.png"],this,fxnImageLoaded).load();
	 
	 // new ImageLoader("../images/",["study1.png","study2.png","study3.png"],this,fxnImageLoaded).load();


	// new ImageLoader("../images/elephant/",["ele_1.JPG","ele_2.JPG","ele_3.JPG","ele_4.JPG","ele_5.JPG","ele_6.JPG"],this,fxnImageLoaded).load();

	// new ImageLoader("../images/",["caseStudy1-0.jpg","caseStudy1-9.jpg","caseStudy1-12.jpg","caseStudy1-14.jpg","caseStudy1-20.jpg","caseStudy1-24.jpg","caseStudy1-26.jpg","caseStudy1-29.jpg"],this,fxnImageLoaded).load();

	// new ImageLoader("../images/room01/",["small_01.JPG","small_02.JPG","small_03.JPG","small_04.JPG","small_05.JPG","small_06.JPG","small_07.JPG","small_08.JPG","small_09.JPG","small_10.JPG","small_11.JPG"],this,fxnImageLoaded).load();

	// new ImageLoader("../images/flowers_1/",["7120.png","7127.png","7131.png","7133.png","7140.png","7141.png","7144.png"],this,fxnImageLoaded).load();

	// new ImageLoader("../images/pika_1/",["image-0.png","image-1.png","image-2.png","image-3.png","image-4.png","image-5.png"],this,fxnImageLoaded).load();

	
}


function testLocationNeighborsSparse(){
	setupDisplay();
	var fxnImageLoaded = function(info){
		console.log("fxnImageLoaded")
		var images = info["images"];

		// get inifial F as previous step

		// use seed points as search locations

		// use neighborhood to increase seed points

		// compare neighborhoods to determine which are likely outliers / wrong
// ???


		var result = R3D.findLocalSupportingCornerMatches(imageScalesA,imageScalesB, pointsA,pointsB, null, affinesAB);
		console.log(result);

// R3D.findLocalSupportingCornerMatchNeighborhoods
		// 


	}
	new ImageLoader("../images/",["bench_A.png","bench_B.png"],this,fxnImageLoaded).load();
}

function testRIFTMatches(){
	// R3D.differentialCornersForImageSingle = function(imageMatrix, suppressDistancePercent){
		setupDisplay();
	var fxnImageLoaded = function(info){
		console.log("fxnImageLoaded")
		var images = info["images"];
		var imageScalesList = [];
		var objectsList = [];
		for(var iii=0; iii<images.length; ++iii){
			var image = images[iii];
			var imageFloat = GLOBALSTAGE.getImageAsFloatRGB(image);
			var imageMatrix = new ImageMat(imageFloat["width"],imageFloat["height"], imageFloat["red"], imageFloat["grn"], imageFloat["blu"]);

			var imageScales = new ImageMatScaled(imageMatrix);
			imageScalesList.push(imageScales);

			image = imageScales.images()[0];
			var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
			var d = new DOImage(img);
			d.matrix().scale(1.0);
			d.matrix().translate(0 + iii*imageMatrix.width(), 0 + 0);
			GLOBALSTAGE.addChild(d);


			var nonMaximalPercent = 0.010;
			// var nonRepeatPercent = 0.001;
			var nonRepeatPercent = 0.005;
			// var imageScales = imageScalesList[0];
			var corners = R3D.optimalCountFeaturesFromImageScales(imageScales, nonMaximalPercent, nonRepeatPercent);
			// R3D.differentialFeaturesFromImage = function(image){
			console.log(corners);

			var features = R3D.colorGradientFeaturesFromPoints(corners,imageScales);
			console.log(features);


			console.log("STARTING FEATURES["+iii+"]: "+features.length);

			// throw "???"

			var points = corners;

			// show accumulated corners

			var d = new DO();
			d.graphics().setFill(0x99FF00FF);
			// d.graphics().setFill(0xFFFFFFFF);
			// d.graphics().setLine(1.0,0xFFFFFFFF);
			console.log("FINAL POINTS: "+points.length)
			for(var i=0; i<points.length; ++i){
break;
				var point = points[i];
				d.graphics().beginPath();
				d.graphics().drawCircle(point.x,point.y,1.0);
				d.graphics().endPath();
				d.graphics().fill();
				/*
				var dir = new V2D(2.0,0);
				// var dir = new V2D(1.0,0);
				dir.rotate(angles[i]);
				d.graphics().beginPath();
				d.graphics().moveTo(point.x,point.y);
				d.graphics().lineTo(point.x+dir.x,point.y+dir.y);
				d.graphics().endPath();
				d.graphics().strokeLine();
				*/
			}
			d.matrix().translate(iii*imageMatrix.width(),0);
			GLOBALSTAGE.addChild(d);

/*
var sizes = [];
for(var i=0; i<features.length; ++i){
	var feature = features[i];
	var size = feature["size"];
	size = size/imageMatrix.size().length();
	sizes.push(size);
}
Code.printMatlabArray(sizes);
*/

			// show finalized features:
/*
			var d = new DO();
			d.graphics().setFill(0xFFFFFFFF);
			// d.graphics().setLine(1.0,0x993366FF);
			d.graphics().setLine(1.0,0xFFFFFFFF);
			console.log("FINAL FEATURES: "+features.length)
			for(var i=0; i<features.length; ++i){
				var feature = features[i];
				var point = feature["point"];
				var angle = feature["angle"];
				var size = feature["size"];

				// size = 2.0;
				// size = size * 0.5;
				d.graphics().beginPath();
				// d.graphics().drawCircle(point.x,point.y,1.0);
				d.graphics().drawCircle(point.x,point.y,size);
				d.graphics().endPath();
				// d.graphics().fill();
				d.graphics().strokeLine();
				
				// var dir = new V2D(2.0,0);
				// var dir = new V2D(1.0,0);
				var dir = new V2D(size,0);
				dir.rotate(angle);
				d.graphics().beginPath();
				d.graphics().moveTo(point.x,point.y);
				d.graphics().lineTo(point.x+dir.x,point.y+dir.y);
				d.graphics().endPath();
				d.graphics().strokeLine();
				
			}
			d.matrix().translate(iii*imageMatrix.width(),0);
			GLOBALSTAGE.addChild(d);
*/

			// var objects = R3D.generateProgressiveSIFTObjects(features, imageScales);
			var objects = R3D.generateProgressiveRIFTObjects(features, imageScales);
			console.log("objects:");
			console.log(objects);
			objectsList.push(objects);
		}
		

		var objectsA = objectsList[0];
		var objectsB = objectsList[1];
		console.log("STARTING RIFT OBJECTS: "+objectsA.length+" & "+objectsB.length);
		var result = R3D.compareProgressiveRIFTObjectsFull(objectsA, objectsB);
		console.log(result);
		// 
		// 
		var matches = result["matches"];
		var d = new DO();
		// d.graphics().setFill(0xFFFFFFFF);
		// d.graphics().setLine(1.0,0x993366FF);
		// d.graphics().setLine(1.0,0xFFFF0000);
var imageA = imageScalesList[0];
var color0 = new V3D(1,0,0);
var color1 = new V3D(0,1,0);
var color2 = new V3D(0,0,1);
// var color3 = new V3D(1,1,1);
var color3 = new V3D(0,0,0);
var colors = [color0,color1,color2,color3];
		for(var i=0; i<matches.length; ++i){
break;
			var match = matches[i];
			// console.log(match);
			var a = match["A"];
			var b = match["B"];
			var pointA = a["point"];
			var pointB = b["point"];
			var size = 2.0;

var p = pointA.copy();
var q = pointB.copy();

var px = (p.x/imageA.width());
var py = (p.y/imageA.height());
var qx = 1 - px;
var qy = 1 - py;
var p0 = qx*qy;
var p1 = px*qy;
var p2 = qx*py;
var p3 = px*py;

// console.log(p0,p1,p2,p3, p0+p1+p2+p3);
var color = V3D.average(colors, [p0,p1,p2,p3]);
color = Code.getColARGBFromFloat(1.0,color.x,color.y,color.z);
			
			d.graphics().setLine(1.0,color);
			// var point = feature["point"];
			// var angle = feature["angle"];
			// var size = feature["size"];
			d.graphics().beginPath();
			d.graphics().drawCircle(pointA.x,pointA.y,size);
			d.graphics().endPath();
			d.graphics().strokeLine();

			d.graphics().beginPath();
			d.graphics().drawCircle(imageA.width() + pointB.x,pointB.y,size);
			d.graphics().endPath();
			d.graphics().strokeLine();
			
			// var dir = new V2D(size,0);
			// dir.rotate(angle);
			// d.graphics().beginPath();
			// d.graphics().moveTo(point.x,point.y);
			// d.graphics().lineTo(point.x+dir.x,point.y+dir.y);
			// d.graphics().endPath();
			// d.graphics().strokeLine();
		}
		d.matrix().translate(0,0);
		GLOBALSTAGE.addChild(d);




		// show top matches:

		for(var i=0; i<matches.length; ++i){
			var match = matches[i];
			// if(i>10){
			if(i>15){
			// if(i>20){
				break;
			}
			var a = match["A"];
			var b = match["B"];
			var imageA = a["image"];
			var imageB = b["image"];


			// var imageA = a["grad"];
			// var imageB = b["grad"];
// console.log(a["grad"]);

			// console.log(imageA);

			var sss = 8;

			var image = imageA;
			var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
			var d = new DOImage(img);
			d.matrix().scale(sss);
			d.matrix().translate(0 + i*80, 0 + 800);
			GLOBALSTAGE.addChild(d);

			var image = imageB;
			var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
			var d = new DOImage(img);
			d.matrix().scale(sss);
			d.matrix().translate(0 + i*80, 0 + 800 + 80);
			GLOBALSTAGE.addChild(d);

			// show rift bins:
			// console.log(a)

			var grad2D = a["grad2DExact"];
// console.log(grad2D);
// throw ".."
			var side = Math.sqrt(grad2D.length);
// console.log(side);
			//var sizePixels = image.width()*sss;
			var sizePixels = image.width()*sss;
			// console.log(sizePixels);
			

lll = [ a, b ];
for(var l=0; l<lll.length; ++l){
	var offX = i*80;
	var offY = 400;
	if(l==1){
		offY += 80;
	}

	var grad2D = lll[l]["grad2DExact"];

// var sifts = [];
// SHOW THE SIFTS ????


			var d = new DO();
			var mmm = 25.0;
			d.graphics().setLine(1.0,0xFF0000CC);
			for(var y=0; y<side; ++y){
				for(var x=0; x<side; ++x){
					var index = y*side + x;
					var v = grad2D[index];
					if(v==null){
						continue;
						v = V2D.ZERO;
					}
					// console.log(v+"");
					var cx = (x+0.5)*sizePixels/side;
					var cy = (y+0.5)*sizePixels/side;
					d.graphics().moveTo( cx, cy );
					d.graphics().lineTo( cx + mmm*v.x, cy + mmm*v.y);
				}
			}
			d.graphics().strokeLine();
			// d.matrix().scale(sss);
			if(l==0){
				d.matrix().translate(0 + i*80, 0 + 800 + 0);
			}else{
				d.matrix().translate(0 + i*80, 0 + 800 + 80);
			}
			GLOBALSTAGE.addChild(d);
}

// throw "ehre"
		}

		// throw "before RANSAC"
		// RANSAC MATCHES:

		var imageMatrixA = imageScalesList[0];
		var imageMatrixB = imageScalesList[1];

		var pointsA = [];
		var pointsB = [];
		for(var i=0; i<matches.length; ++i){
			var match = matches[i];
			var a = match["A"];
			var b = match["B"];
			pointsA.push(a["point"]);
			pointsB.push(b["point"]);
		}
		// console.log(pointsA);
		// console.log(pointsB);
		// console.log("SIZE: "+imageMatrixA.size()); // 504x378
		var errorPixels = imageMatrixA.size().length() * 0.01; // 5%=31.5px | 1%=6px  0.005=3px
		// console.log("errorPixels: "+errorPixels);
		var result = R3D.fundamentalRANSACFromPoints(pointsA,pointsB, errorPixels, null, 0.50, 0.999);
		console.log(result);
		var F = result["F"];
		var best = result["matches"];
		var bestA = best[0];
		var bestB = best[1];
		console.log(bestA,bestB);
		F = R3D.fundamentalFromUnnormalized(bestA,bestB);


		var Finv = R3D.fundamentalInverse(F);
		console.log(F);
		var info = R3D.fundamentalError(F,Finv,bestA,bestB);
			var fMean = info["mean"];
			var fSigma = info["sigma"];
			var fError = fMean + fSigma;
		console.log("F ERROR: "+fMean+" +/- "+fSigma);


		// var FFwd = R3D.fundamentalFromUnnormalized(subsetPointsA,subsetPointsB);
		// var FRev = R3D.fundamentalInverse(FFwd);




// R3D.showRansac(bestA,bestB, F,Finv, null, imageMatrixA,imageMatrixB);
		
		

		// R3D.fundamentalRANSACFromPoints = function(pointsAIn,pointsBIn, errorPosition, initialF, pOutlier, pDesired){
		// R3D.fundamentalFromRansacImageMatches = function(imageMatrixA,imageMatrixB, matches){
		// R3D.showRansac = function(pointsA, pointsB, matrixFfwd, matrixFrev, display, imageMatrixA,imageMatrixB){


		console.log(bestA);
		console.log(bestB);
		console.log(matches);
		// reverse lookup
		var matchesLookup = {};
		for(var i=0; i<matches.length; ++i){
			var match = matches[i];
			var A = match["A"];
			var a = A["point"];
			var index = a.x+"-"+a.y;
			matchesLookup[index] = match;
		}
		var matchesAB = [];
		var v = new V2D();
		for(var i=0; i<bestA.length; ++i){
			var a = bestA[i];
			var index = a.x+"-"+a.y;
			var match = matchesLookup[index];
			// console.log(match);
			var A = match["A"];
			var B = match["B"];
			var scale = B["size"]/A["size"];
				v.set(1,0);
				v.rotate(-A["angle"]);
				v.rotate(B["angle"]);
			var angle = V2D.angleDirection(V2D.DIRX,v);
// console.log(Code.degrees(angle));
			var affine = new Matrix2D();
				affine.scale(scale);
				affine.rotate(angle);
			var matchAB = {};
				matchAB["A"] = A["point"];
				matchAB["B"] = B["point"];
				matchAB["affine"] = affine;
			matchesAB.push(matchAB);
		}

		var matches = matchesAB;

		var result = R3D.keepExtendedMatchNeighborhoods(imageMatrixA,imageMatrixB, matches);
		console.log(result);
		var matches = result["matches"];


		var result = R3D.optimizeMatchLocations(imageMatrixA,imageMatrixB, matches);
		console.log(result);
		var matches = result["matches"];

		// var pointsA = [];
		// var pointsB = [];
		// for(var i=0; i<matches.length; ++i){
		// 	var match = matches[i];
		// 	var pA = match["A"];
		// 	var pB = match["B"];
		// 	pointsA.push(pA);
		// 	pointsB.push(pB);
		// }
		// F = R3D.fundamentalFromUnnormalized(pointsA,pointsB);
		// var Finv = R3D.fundamentalInverse(F);
		// var info = R3D.fundamentalError(F,Finv,pointsA,pointsB);
		// 	var fMean = info["mean"];
		// 	var fSigma = info["sigma"];
		// 	var fError = fMean + fSigma;
		// console.log("F ERROR: "+fMean+" +/- "+fSigma);
		// var d = new DO();
		// d.graphics().setFill(0x99FFFFFF);
		// // d.graphics().setFill(0x66FFFFFF);
		// d.graphics().beginPath();
		// d.graphics().drawRect(0,0, 2200,1200);
		// d.graphics().endPath();
		// d.graphics().fill();
		// d.matrix().translate(0,0);
		// GLOBALSTAGE.addChild(d);
		// R3D.showRansac(pointsA,pointsB, F,Finv, null, imageMatrixA,imageMatrixB);



		var imageCornerDensityPercent = null;
		var result = R3D.findLocalSupportingCornerMatchNeighborhoods(imageMatrixA,imageMatrixB, matches, imageCornerDensityPercent);
		console.log(result);
		var matches = result["matches"];

/*
		var pointsA = [];
		var pointsB = [];
		for(var i=0; i<matches.length; ++i){
			var match = matches[i];
			var pA = match["A"];
			var pB = match["B"];
			pointsA.push(pA);
			pointsB.push(pB);
		}
		F = R3D.fundamentalFromUnnormalized(pointsA,pointsB);
		var Finv = R3D.fundamentalInverse(F);
		var info = R3D.fundamentalError(F,Finv,pointsA,pointsB);
			var fMean = info["mean"];
			var fSigma = info["sigma"];
			var fError = fMean + fSigma;
		console.log("F ERROR: "+fMean+" +/- "+fSigma);
		var d = new DO();
		d.graphics().setFill(0x99FFFFFF);
		// d.graphics().setFill(0x66FFFFFF);
		d.graphics().beginPath();
		d.graphics().drawRect(0,0, 2200,1200);
		d.graphics().endPath();
		d.graphics().fill();
		d.matrix().translate(0,0);
		GLOBALSTAGE.addChild(d);
		R3D.showRansac(pointsA,pointsB, F,Finv, null, imageMatrixA,imageMatrixB);
*/

		// R3D.findLocalSupportingCornerMatches = function(imageMatrixA,imageMatrixB, pointsA,pointsB, imageCornerDensityPercent, affinesAB){ // 

		// R3D.findLocalSupportingCornerMatchNeighborhoods();



	}
	// new ImageLoader("../images/iowa/",["0.JPG","1.JPG"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/iowa/",["0.JPG","2.JPG"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/iowa/",["5.JPG","6.JPG"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/iowa/",["6.JPG","7.JPG"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/iowa/",["7.JPG","8.JPG"],this,fxnImageLoaded).load(); // hard
	// new ImageLoader("../images/iowa/",["8.JPG","9.JPG"],this,fxnImageLoaded).load();

	// new ImageLoader("../images/",["bench_A.png","bench_B.png"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/",["bench_B.png","bench_C.png"],this,fxnImageLoaded).load();
	new ImageLoader("../images/",["bench_E.png","bench_F.png"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/",["room0.png","room2.png"],this,fxnImageLoaded).load();
	
	// new ImageLoader("../images/",["caseStudy1-0.jpg","caseStudy1-9.jpg"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/",["caseStudy1-20.jpg","caseStudy1-24.jpg"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/",["caseStudy1-20.jpg","caseStudy1-26.jpg"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/",["caseStudy1-26.jpg","caseStudy1-29.jpg"],this,fxnImageLoaded).load();

	// new ImageLoader("../images/",["zA_small.jpg","zB_small.jpg"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/",["temple_1.png","temple_2.png"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/",["castle.000.jpg","castle.009.jpg"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/",["bt.000.png","bt.006.png"],this,fxnImageLoaded).load();

	// new ImageLoader("../images/elephant/",["ele_1.JPG","ele_6.JPG"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/elephant/",["ele_1.JPG","ele_5.JPG"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/elephant/",["ele_1.JPG","ele_4.JPG"],this,fxnImageLoaded).load();

	// new ImageLoader("../images/rabbit/",["1.jpg","2.jpg"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/rabbit/",["1.jpg","3.jpg"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/rabbit/",["10.jpg","11.jpg"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/rabbit/",["6.jpg","9.jpg"],this,fxnImageLoaded).load();


	// new ImageLoader("../images/rabbit/",["E.jpg","E.jpg"],this,fxnImageLoaded).load();


	// new ImageLoader("../images/flowers_1/",["7120.png","7127.png","7131.png","7133.png","7140.png","7141.png","7144.png"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/flowers_1/",["7120.png","7127.png"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/flowers_1/",["7131.png","7133.png"],this,fxnImageLoaded).load();

	// new ImageLoader("../images/room01/",["small_01.JPG","small_02.JPG"],this,fxnImageLoaded).load();

	// new ImageLoader("../images/pika_1/",["image-0.png","image-1.png"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/pika_1/",["image-0.png","image-2.png"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/pika_1/",["image-0.png","image-5.png"],this,fxnImageLoaded).load();

	// new ImageLoader("../images/",["F_S_1_1.jpg","F_S_1_2.jpg"],this,fxnImageLoaded).load();

	// new ImageLoader("../images/",["graffiti_1.png","graffiti_2.png"],this,fxnImageLoaded).load();

	// new ImageLoader("../images/",["medusa_1.png","medusa_2.png"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/",["medusa_1.png","medusa_3.png"],this,fxnImageLoaded).load();


}


function testCorners(){
	// R3D.differentialCornersForImageSingle = function(imageMatrix, suppressDistancePercent){
		setupDisplay();
	var fxnImageLoaded = function(info){
		console.log("fxnImageLoaded")
		var images = info["images"];
	for(var iii=0; iii<images.length; ++iii){
		var image = images[iii];
		var imageFloat = GLOBALSTAGE.getImageAsFloatRGB(image);
		var imageMatrix = new ImageMat(imageFloat["width"],imageFloat["height"], imageFloat["red"], imageFloat["grn"], imageFloat["blu"]);


// imageMatrix.clear();
// imageMatrix.drawRect( 100,100, 20,50, new V3D(1.0,0.0,0.50));
// imageMatrix.drawRect( 10,110, 200,4, new V3D(0.0,0.0,0.50));
// imageMatrix.drawRect( 105,95, 10,100, new V3D(1.0,0.5,0.50));

		var imageScales = new ImageMatScaled(imageMatrix);


		image = imageScales.images()[0];
		var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
		var d = new DOImage(img);
		d.matrix().scale(1.0);
		d.matrix().translate(0 + iii*imageMatrix.width(), 0 + 0);
		GLOBALSTAGE.addChild(d);


		var suppressDistancePercent = 0.01;
		// var suppressDistancePercent = 0.005;
		// var suppressDistancePercent = 0.001;
		var info = R3D.differentialCornersForImageSingle(imageMatrix, suppressDistancePercent);
		console.log(info);
var points = info["points"];
var angles = info["angles"];
var directions = info["directions"];

		// var info = R3D.imageCornersDifferential(image, false);
		// console.log(info);
		// var values = info[]


		// var colors = [0xFF000000, 0xFF000099, 0xFF0000FF, 0xFFCC00CC, 0xFFFF0000, 0xFF990000, 0xFFFFFFFF];
		// var colors = [0xFF000000, 0xFFFFFFFF];
		var colors = [0xFF000000, 0xFF000099, 0xFF9900CC, 0xFFCC0099, 0xFFCC0000, 0xFFFFFFFF];
		var values = Code.copyArray(info["value"]);

// console.log(values);
// throw "???"

		// var values = Code.copyArray(info["angles"]);
			ImageMat.normalFloat01(values);
			ImageMat.pow(values,0.50);
			// ImageMat.pow(values,0.25);
		var heat = ImageMat.heatImage(values, imageMatrix.width(), imageMatrix.height(), false, colors);

		image = heat;
		var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
		var d = new DOImage(img);
		d.matrix().scale(1.0);
		d.matrix().translate(iii*imageMatrix.width(),0);
		// d.graphics().alpha(0.50);
		d.graphics().alpha(0.60);
		// d.graphics().alpha(0.75);
		// d.graphics().alpha(0.90);
		GLOBALSTAGE.addChild(d);

		

		var width = imageMatrix.width();
		var height = imageMatrix.height();
		var d = new DO();
		// d.graphics().setFill(0xFFFFFFFF);
		d.graphics().setLine(1.0,0xFFFFFFFF);
		var point = new V2D();
		var sss = 1;
		var dd = 3;
		for(var j=0; j<height; j+=dd){
			break;
			for(var i=0; i<width; i+=dd){
				var index = j*width + i;
				point.set(i,j);
				var dir = directions[index];
				// d.graphics().drawCircle(point.x,point.y,1.0);
				// d.graphics().drawCircle(point.x,point.y,0.5);
				// d.graphics().endPath();
				// d.graphics().fill();
				// 
				// var dir = new V2D(2.0,0);
				// var dir = new V2D(1.0,0);
				// d.graphics().beginPath();
				// dir.rotate(angles[i]);
				d.graphics().beginPath();
				d.graphics().moveTo(point.x-dir.x*sss,point.y-dir.y*sss);
				d.graphics().lineTo(point.x+dir.x*sss,point.y+dir.y*sss);
				d.graphics().endPath();
				d.graphics().strokeLine();
			}
		}
		d.matrix().translate(iii*imageMatrix.width(),0);
		GLOBALSTAGE.addChild(d);


		var d = new DO();
		d.graphics().setFill(0xFFFFFFFF);
		d.graphics().setLine(1.0,0xFFFFFFFF);
console.log("FINAL POINTS: "+points.length)
		for(var i=0; i<points.length; ++i){
// break;
			var point = points[i];
			d.graphics().beginPath();
			d.graphics().drawCircle(point.x,point.y,1.0);
			// d.graphics().drawCircle(point.x,point.y,0.5);
			d.graphics().endPath();
			d.graphics().fill();

			var dir = new V2D(2.0,0);
			// var dir = new V2D(1.0,0);
			dir.rotate(angles[i]);
			d.graphics().beginPath();
			d.graphics().moveTo(point.x,point.y);
			d.graphics().lineTo(point.x+dir.x,point.y+dir.y);
			d.graphics().endPath();
			d.graphics().strokeLine();
		}
		d.matrix().translate(iii*imageMatrix.width(),0);
		GLOBALSTAGE.addChild(d);
}
	}
	// new ImageLoader("../images/iowa/",["5.JPG"],this,fxnImageLoaded).load();
	new ImageLoader("../images/iowa/",["5.JPG","6.JPG"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/",["bench_A.png","bench_B.png"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/",["caseStudy1-0.jpg","caseStudy1-9.jpg"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/",["zA_small.jpg","zB_small.jpg"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/",["temple_1.png","temple_2.png"],this,fxnImageLoaded).load();
	// new ImageLoader("../images/",["room0.png","room2.png"],this,fxnImageLoaded).load();
	
}

function testExtraction(){
	setupDisplay();
	var fxnImageLoaded = function(info){
		console.log("fxnImageLoaded")
		var images = info["images"];
		var image = images[0];
		var imageFloat = GLOBALSTAGE.getImageAsFloatRGB(image);
		var imageMatrix = new ImageMat(imageFloat["width"],imageFloat["height"], imageFloat["red"], imageFloat["grn"], imageFloat["blu"]);
		
		var imageScales = new ImageMatScaled(imageMatrix);

		// var needlePoint = new V2D(125,190); // addr corner


		var needlePoint = new V2D(Math.random()*400,Math.random()*300); // addr corner


		var affine = new Matrix2D();
		// ...
		// 
		// var needleSize = 11;
		// var needleSize = 21;
		var needleSize = 41;
		// var needleSize = 51;
		var haystackSize = 8*needleSize + 0;
		var needleHalf = (needleSize-1)*0.5;
		var needle = new ImageMat(needleSize,needleSize);


		var angle = 0.0;
		// var scale = 1.0;
		var scale = 1.5;
		// var scale = 2.0;
		// var scale = 2.5;
var sss = 1.0;

var scales = Code.divSpace(-2,2, 10);
var entropies = [];
for(var i=0; i<scales.length; ++i){
var scale = scales[i];
scale = Math.pow(2,scale);
// console.log(scale);
		affine.identity();
		affine.rotate(angle);
		affine.scale(scale);
		ImageMatScaled.affineToLocationTransform(affine, affine, needleHalf,needleHalf,needlePoint.x,needlePoint.y);
		var averageScale = affine.averageScale();
		// 
		// 
		imageScales.extractRectCombineFast(needle, averageScale, affine);
		// console.log(needle);
		// 
		// 
		var data = needle.gry(null);
		var data = needle.gry();
// console.log(data);
		var buckets = 10;
		var entropy = Code.entropy01(data, buckets);
		// 
		console.log("entropy: "+entropy);
		//
		entropies.push(entropy);



		image = needle;
		var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
		var d = new DOImage(img);
		d.matrix().scale(sss);
		d.matrix().translate(10 + 100*i, 10 + 100);
		GLOBALSTAGE.addChild(d);
}
Code.printMatlabArray(entropies);


		


		image = needle;
		var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
		var d = new DOImage(img);
		d.matrix().scale(sss);
		d.matrix().translate(10 + 0, 10 + 0);
		GLOBALSTAGE.addChild(d);



		imageScales.extractRectFast(needle, averageScale, affine);
		

		image = needle;
		var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
		var d = new DOImage(img);
		d.matrix().scale(sss);
		d.matrix().translate(10 + 200, 10 + 0);
		GLOBALSTAGE.addChild(d);


	}
	new ImageLoader("../images/iowa/",["5.JPG"],this,fxnImageLoaded).load();
}

function testLocationSeparate(){
	
	setupDisplay();
	var fxnImageLoaded = function(info){
		var images = info["images"];
		var matrixes = [];
		var scales = [];
		//var imageScales = [];
		for(var i=0; i<images.length; ++i){
			var image = images[i];
			var imageFloat = GLOBALSTAGE.getImageAsFloatRGB(image);
			var imageMatrix = new ImageMat(imageFloat["width"],imageFloat["height"], imageFloat["red"], imageFloat["grn"], imageFloat["blu"]);
			var imageScales = new ImageMatScaled(imageMatrix);
				matrixes[i] = imageMatrix;
				scales[i] = imageScales;
			// 
			image = imageMatrix;
			var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
			var d = new DOImage(img);
			d.matrix().scale(1.0);
			d.matrix().translate(0 + i*imageMatrix.width(), 0 + 0);
			GLOBALSTAGE.addChild(d);
		}
		// ... 
		var imageScalesA = scales[0];
		var imageScalesB = scales[1];
		// CHAIR CORNER
			var needlePointA = new V2D(220,210);
			var needlePointB = new V2D(290,254);
		// CAMERA
			// var needlePointA = new V2D(278,160);
			// var needlePointB = new V2D(370,190);
		// DOOR HANDLE
			// var needlePointA = new V2D(90,208);
			// var needlePointB = new V2D(129,240);
			// var needlePointA = new V2D(88,203);
			// var needlePointB = new V2D(129,235);

			// var needlePointA = new V2D(80,200);
			// var needlePointB = new V2D(120,235);

			// var needlePointA = new V2D(40,170);
			// var needlePointB = new V2D(70,190);

		// chimes
			// var needlePointA = new V2D(202,172);
			// var needlePointB = new V2D(265,205);

		// window
			// var needlePointA = new V2D(225,90);
			// var needlePointB = new V2D(300,110);
		// right win // ?????????
			// var needlePointA = new V2D(300,205);
			// var needlePointB = new V2D(401,255);
		// chair
			// var needlePointA = new V2D(140,229);
			// var needlePointB = new V2D(190,269);

			// var needlePointA = new V2D(92,245);
			// var needlePointB = new V2D(130,289);

			// var needlePointA = new V2D(275,175);
			// var needlePointB = new V2D(370,210);

		//
			// var needlePointA = new V2D(262,150);
			// var needlePointB = new V2D(350,180);

			// var needlePointA = new V2D(262,165);
			// var needlePointB = new V2D(350,195);

		// tree
			// var needlePointA = new V2D(190,49);
			// var needlePointB = new V2D(260,77);

			// var needlePointA = new V2D(215,40);
			// var needlePointB = new V2D(289,70);

			// var needlePointA = new V2D(290,115);
			// var needlePointB = new V2D(375,150);

		// clouds
			// var needlePointA = new V2D(300,20);
			// var needlePointB = new V2D(420,60);
		// broom top
			// var needlePointA = new V2D(28,202);
			// var needlePointB = new V2D(49,230);

// throw "?"
		// ...
		// ... 
		var affine = new Matrix2D();
		// ...
		// 
		var needleSize = 11;
		// var needleSize = 21;
		// var needleSize = 41;
		// var needleSize = 51;
		var haystackSize = 8*needleSize + 0;
		var needleHalf = (needleSize-1)*0.5;
		var needleA = new ImageMat(needleSize,needleSize);
		var needleB = new ImageMat(needleSize,needleSize);
//		var haystack = new ImageMat(haystackSize,haystackSize);
		//
var averageScale;
// console.log(imageScalesB);
// throw "..."
		//
		console.log("needleHalf: "+needleHalf);
//		console.log("haystackHalf: "+haystackHalf);
		// needle
		affine.identity();
		affine.rotate(0.0);
		affine.scale(1.0);
		// ..
		ImageMatScaled.affineToLocationTransform(affine, affine, needleHalf,needleHalf,needlePointA.x,needlePointA.y);
		var averageScale = affine.averageScale();
		imageScalesA.extractRectFast(needleA, averageScale, affine);
		// ..
		affine.identity();
		affine.rotate(0.0);
		affine.scale(1.0);
		ImageMatScaled.affineToLocationTransform(affine, affine, needleHalf,needleHalf,needlePointB.x,needlePointB.y);
		var averageScale = affine.averageScale();
		imageScalesB.extractRectFast(needleB, averageScale, affine);
		// ..
		// ..
			// ...
// console.log(imageScalesA);
// console.log(needleA);
// console.log(affine);
			
			// ...
		/*
		var needleMask = null;
		var scores = R3D.searchNeedleHaystackSADColor(needleA,haystackB,needleMask);
		var valueScores = scores["value"];
		var valueWidth = scores["width"];
		var valueHeight = scores["height"];
		*/

		image = needleA;
		var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
		var d = new DOImage(img);
		d.matrix().scale(3.0);
		d.matrix().translate(10 + 0, 10 + 0);

		d.graphics().setLine(1.0, 0xFFFF0000);
		d.graphics().beginPath();
/*
		d.graphics().moveTo(needleHalf,0);
		d.graphics().lineTo(needleHalf,needleSize);
		d.graphics().moveTo(0,needleHalf);
		d.graphics().lineTo(needleSize,needleHalf);
		d.graphics().endPath();
		d.graphics().strokeLine();
*/


		GLOBALSTAGE.addChild(d);
		//
		image = needleB;
		var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
		var d = new DOImage(img);
		d.matrix().scale(3.0);
		d.matrix().translate(10 + 100, 10 + 0);
		GLOBALSTAGE.addChild(d);
		// ...
			// ...
		// ...
			// ...
		// ...
		//
		//
		var featureSize = needleSize;
		var haystackSize = needleSize*2;
		// var haystackSize = Math.round(needleSize*1.5);
		var affineAB = new Matrix2D();
			affineAB.identity();
		//
		var result = R3D.optimumSADLocationSearchFlatRGB(needlePointA,needlePointB, imageScalesA,imageScalesB, featureSize, needleSize,haystackSize, affineAB);
		var point = result["point"];
		console.log(point+"");


		// var scores = R3D.searchNeedleHaystackSADColorOffsetUnit(needle,haystack);

		var bestPointB = point;

		console.log("DIFF: "+V2D.distance(point,needlePointB));


/*

		var result = R3D.testOptimumLocationSAD(needlePointA,needlePointB, imageScalesA,imageScalesB, featureSize, needleSize,haystackSize, affineAB);
		console.log(result);

		var result = R3D.testOptimumLocationSADOffset(needlePointA,needlePointB, imageScalesA,imageScalesB, featureSize, needleSize,haystackSize, affineAB);
		console.log(result);

		var result = R3D.testOptimumLocationSADOffsetUnit(needlePointA,needlePointB, imageScalesA,imageScalesB, featureSize, needleSize,haystackSize, affineAB);
		console.log(result);

		var result = R3D.testOptimumLocationSSD(needlePointA,needlePointB, imageScalesA,imageScalesB, featureSize, needleSize,haystackSize, affineAB);
		console.log(result);

		var result = R3D.testOptimumLocationSSDOffset(needlePointA,needlePointB, imageScalesA,imageScalesB, featureSize, needleSize,haystackSize, affineAB);
		console.log(result);

		var result = R3D.testOptimumLocationSSDOffsetUnit(needlePointA,needlePointB, imageScalesA,imageScalesB, featureSize, needleSize,haystackSize, affineAB);
		console.log(result);

		var result = R3D.testOptimumLocationNCC(needlePointA,needlePointB, imageScalesA,imageScalesB, featureSize, needleSize,haystackSize, affineAB);
		console.log(result);

		
*/

// throw "..."



		//var result = R3D.optimumAffineCornerTransform(imageA,pointA, imageB,pointB, affine, compareSize, 10);
		// var result = R3D.optimizeSADAffineCorner(newMatch.point2DA().point2D(),newMatch.point2DB().point2D(),

		var matrixIn = new Matrix2D();
			matrixIn.identity();

		var compareSize = featureSize;
			compareSize = 11;
		var result = R3D.optimizeSADAffineCorner(needlePointA,bestPointB, imageScalesA,imageScalesB, featureSize, compareSize, matrixIn);

		var affine = result["affine"];
		console.log(result);

var bestAB = affine.copy();
// bestAB.inverse();
// bestAB.identity();

		console.log(affine==matrixIn);


		//R3D.optimizeSADAffineCorner(pointA,pointB, imageScalesA,imageScalesB, featureSize,compareSize,    matrixIn, maxIterations, reuseA,reuseB,mask, reuseC,reuseMatrix){

		// 

		var bestB = new ImageMat(needleSize,needleSize);



affine.inverse();
		//affine.identity();
		//affine.rotate(0.0);
		//affine.scale(1.0);
		// ..
		ImageMatScaled.affineToLocationTransform(affine, affine, needleHalf,needleHalf,bestPointB.x,bestPointB.y);
		var averageScale = affine.averageScale();
		imageScalesB.extractRectFast(bestB, averageScale, affine);


		
		image = bestB;
		var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
		var d = new DOImage(img);
		d.matrix().scale(3.0);
		d.matrix().translate(10 + 0, 10 + 100);
		GLOBALSTAGE.addChild(d);









		// neighbors:
		var pointsA = [needlePointA];
		var pointsB = [bestPointB];
		var affinesAB = [bestAB];
// console.log(affinesAB);
// throw "?"

		var result = R3D.findLocalSupportingCornerMatches(imageScalesA,imageScalesB, pointsA,pointsB, null, affinesAB);
		console.log(result);

		var pointsA = result["A"];
		var pointsB = result["B"];
		for(var i=0; i<pointsA.length; ++i){
			var pA = pointsA[i];
			var pB = pointsB[i];

			var d = new DO();
			d.graphics().setLine(1.0,0x66FFFFFF);
			d.graphics().beginPath();
			d.graphics().drawCircle(pA.x,pA.y,2.0);
			d.graphics().endPath();
			d.graphics().strokeLine();
			GLOBALSTAGE.addChild(d);

			var d = new DOText(""+i, 7, DOText.FONT_ARIAL, 0xFF00CC00, DOText.ALIGN_CENTER);
			d.matrix().translate(pA.x,pA.y + 3);
			GLOBALSTAGE.addChild(d);


			var d = new DO();
			d.graphics().setLine(1.0,0x66FFFFFF);
			d.graphics().beginPath();
			d.graphics().drawCircle(pB.x,pB.y,2.0);
			d.graphics().endPath();
			d.graphics().strokeLine();
			GLOBALSTAGE.addChild(d);
			d.matrix().translate(imageScalesA.width(), 0);

			var d = new DOText(""+i, 7, DOText.FONT_ARIAL, 0xFF00CC00, DOText.ALIGN_CENTER);
			d.matrix().translate(pB.x,pB.y + 3);
			GLOBALSTAGE.addChild(d);
			d.matrix().translate(imageScalesA.width(), 0);
		}

	}

	new ImageLoader("../images/iowa/",["5.JPG","6.JPG"],this,fxnImageLoaded).load();
}


function testLocalize(){
	
	setupDisplay();
	var fxnImageLoaded = function(info){
		var images = info["images"];
		var image = images[0];
		var imageFloat = GLOBALSTAGE.getImageAsFloatRGB(image);
		var imageMatrix = new ImageMat(imageFloat["width"],imageFloat["height"], imageFloat["red"], imageFloat["grn"], imageFloat["blu"]);
		
		var imageScales = new ImageMatScaled(imageMatrix);

		var needlePoint = new V2D(125,190); // addr corner
		// var needlePoint = new V2D(145,199); // bricks
		// var needlePoint = new V2D(225,215); // swing
		// var needlePoint = new V2D(145,290); // bridk edge
		// var needlePoint = new V2D(141,270);
		// var needlePoint = new V2D(145,120); // siding
		// var needlePoint = new V2D(245,290); // bush
		// var needlePoint = new V2D(395,280); // grass


		// var needlePoint = new V2D(145,120);
		// var haystackPoint = new V2D().add(needlePoint).add(new V2D(0.0,0.0));
		var haystackPoint = new V2D().add(needlePoint).add(new V2D(3.0,4.0));

		var needleSize = 21;

		var haystackSize = 8*needleSize + 0;

		var needleHalf = (needleSize-1)*0.5;
		var haystackHalf = (haystackSize-1)*0.5;
		var scale = 0.50;
		// var scale = 1.0;
		var angle = Code.radians(0.0);

		var affine = new Matrix2D();


var distortionAngle = Code.radians(0.0);
var distortionScale = 1.0;

// var distortionAngle = Code.radians(10.0);
// var distortionScale = 1.1;
			

		var needle = new ImageMat(needleSize,needleSize);
		var haystack = new ImageMat(haystackSize,haystackSize);


console.log("needleHalf: "+needleHalf);
console.log("haystackHalf: "+haystackHalf);
		
		// needle
		affine.identity();
		affine.rotate(angle);
		affine.scale(scale);
		ImageMatScaled.affineToLocationTransform(affine, affine, needleHalf,needleHalf,needlePoint.x,needlePoint.y);
		var averageScale = affine.averageScale();
		imageScales.extractRectFast(needle, averageScale, affine);

		// haystack
		affine.identity();
		affine.rotate(angle);
		affine.scale(scale);
// distortion
// affine.rotate(Code.radians(0.0));
affine.rotate(distortionAngle);
affine.scale(distortionScale);
		ImageMatScaled.affineToLocationTransform(affine, affine, haystackHalf,haystackHalf,haystackPoint.x,haystackPoint.y);
		var averageScale = affine.averageScale();
		imageScales.extractRectFast(haystack, averageScale, affine);


		// find needle/haystack
		var needleMask = null;
		var scores = R3D.searchNeedleHaystackSADColor(needle,haystack,needleMask);
		var valueScores = scores["value"];
		var valueWidth = scores["width"];
		var valueHeight = scores["height"];

		// show:
		image = imageMatrix;
		var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
		var d = new DOImage(img);
		d.matrix().scale(1.0);
		d.matrix().translate(10 + 0, 10 + 0);
		GLOBALSTAGE.addChild(d);


		image = needle;
		var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
		var d = new DOImage(img);
		d.matrix().scale(1.0);
		d.matrix().translate(10 + 0, 10 + 0);
		GLOBALSTAGE.addChild(d);

		image = haystack;
		var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
		var d = new DOImage(img);
		d.matrix().scale(1.0);
		d.matrix().translate(10 + 100, 10 + 0);
		GLOBALSTAGE.addChild(d);


		// heat map matches
		var colors = [0xFF000099, 0xFF0000FF, 0xFFCC00CC, 0xFFFF0000, 0xFF990000, 0x00];
		// var colors = [0xFFFFFFFF, 0xFF000000];
		// var colors = [0xFF000000, 0xFFFFFFFF];
		var values = Code.copyArray(valueScores);
			ImageMat.normalFloat01(values);
			ImageMat.pow(values,0.50);
		var heat = ImageMat.heatImage(values, valueWidth, valueHeight, true, colors);

		image = heat;
		var img = GLOBALSTAGE.getFloatRGBAsImage(image.red(),image.grn(),image.blu(), image.width(),image.height());
		var d = new DOImage(img);
		d.matrix().scale(1.0);
		d.matrix().translate(10 + 100, 10 + 0);
		d.matrix().translate((haystack.width()-heat.width())*0.5, (haystack.height()-heat.height())*0.5);
		d.graphics().alpha(0.50);
		GLOBALSTAGE.addChild(d);



		var featureSize = needleSize;

featureSize = 3;
// featureSize = 5;
// featureSize = 11;
// featureSize = 21;
// featureSize = 41;
// featureSize = 81;
		
		// var featureSize = 11;
		// var needleSize = 11;
		// var haystackSize = 2*needleSize;
		// var haystackSize = 4*needleSize;
		// var haystackSize = 21;
		var affineAB = new Matrix2D();
			// distortion:
			// affineAB.identity();
			// affineAB.rotate(Code.radians(10.0));
			// affineAB.scale(1.1);
			affineAB.rotate(distortionAngle);
			affineAB.scale(distortionScale);

		var result = R3D.optimumSADLocationSearchFlatRGB(needlePoint,haystackPoint, imageScales,imageScales, featureSize, needleSize,haystackSize, affineAB);
		// console.log(result);
		var point = result["point"];
		console.log(point+"");

		console.log("DIFF: "+V2D.distance(point,needlePoint));



	}
	new ImageLoader("../images/iowa/",["5.JPG"],this,fxnImageLoaded).load();
	// point is extracted
}

function testFindSame(){
	// find same point in image given a needle/hastack off-center
}


function testFindWarpedSame(){
	// find same point in image after needle is distorted affine matrix
	// 
}

function testFindNeighbors(){
	// find matching neighbor points around matching area
	// 
}

</script>
<body onload="pageLoadedFxn();">
</body>
</html>